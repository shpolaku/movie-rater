"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,`__esModule`,{value:!0}),exports.WriteStreamSync=exports.WriteStream=exports.ReadStreamSync=exports.ReadStream=void 0;const events_1=__importDefault(require(`events`)),fs_1=__importDefault(require(`fs`)),minipass_1=require(`minipass`),writev=fs_1.default.writev,_autoClose=Symbol(`_autoClose`),_close=Symbol(`_close`),_ended=Symbol(`_ended`),_fd=Symbol(`_fd`),_finished=Symbol(`_finished`),_flags=Symbol(`_flags`),_flush=Symbol(`_flush`),_handleChunk=Symbol(`_handleChunk`),_makeBuf=Symbol(`_makeBuf`),_mode=Symbol(`_mode`),_needDrain=Symbol(`_needDrain`),_onerror=Symbol(`_onerror`),_onopen=Symbol(`_onopen`),_onread=Symbol(`_onread`),_onwrite=Symbol(`_onwrite`),_open=Symbol(`_open`),_path=Symbol(`_path`),_pos=Symbol(`_pos`),_queue=Symbol(`_queue`),_read=Symbol(`_read`),_readSize=Symbol(`_readSize`),_reading=Symbol(`_reading`),_remain=Symbol(`_remain`),_size=Symbol(`_size`),_write=Symbol(`_write`),_writing=Symbol(`_writing`),_defaultFlag=Symbol(`_defaultFlag`),_errored=Symbol(`_errored`);class ReadStream extends minipass_1.Minipass{[_errored]=!1;[_fd];[_path];[_readSize];[_reading]=!1;[_size];[_remain];[_autoClose];constructor(e,t){if(t||={},super(t),this.readable=!0,this.writable=!1,typeof e!=`string`)throw TypeError(`path must be a string`);this[_errored]=!1,this[_fd]=typeof t.fd==`number`?t.fd:void 0,this[_path]=e,this[_readSize]=t.readSize||16*1024*1024,this[_reading]=!1,this[_size]=typeof t.size==`number`?t.size:1/0,this[_remain]=this[_size],this[_autoClose]=typeof t.autoClose==`boolean`?t.autoClose:!0,typeof this[_fd]==`number`?this[_read]():this[_open]()}get fd(){return this[_fd]}get path(){return this[_path]}write(){throw TypeError(`this is a readable stream`)}end(){throw TypeError(`this is a readable stream`)}[_open](){fs_1.default.open(this[_path],`r`,(e,t)=>this[_onopen](e,t))}[_onopen](e,t){e?this[_onerror](e):(this[_fd]=t,this.emit(`open`,t),this[_read]())}[_makeBuf](){return Buffer.allocUnsafe(Math.min(this[_readSize],this[_remain]))}[_read](){if(!this[_reading]){this[_reading]=!0;let e=this[_makeBuf]();if(e.length===0)return process.nextTick(()=>this[_onread](null,0,e));fs_1.default.read(this[_fd],e,0,e.length,null,(e,t,n)=>this[_onread](e,t,n))}}[_onread](e,t,n){this[_reading]=!1,e?this[_onerror](e):this[_handleChunk](t,n)&&this[_read]()}[_close](){if(this[_autoClose]&&typeof this[_fd]==`number`){let e=this[_fd];this[_fd]=void 0,fs_1.default.close(e,e=>e?this.emit(`error`,e):this.emit(`close`))}}[_onerror](e){this[_reading]=!0,this[_close](),this.emit(`error`,e)}[_handleChunk](e,t){let n=!1;return this[_remain]-=e,e>0&&(n=super.write(e<t.length?t.subarray(0,e):t)),(e===0||this[_remain]<=0)&&(n=!1,this[_close](),super.end()),n}emit(e,...t){switch(e){case`prefinish`:case`finish`:return!1;case`drain`:return typeof this[_fd]==`number`&&this[_read](),!1;case`error`:return this[_errored]?!1:(this[_errored]=!0,super.emit(e,...t));default:return super.emit(e,...t)}}}exports.ReadStream=ReadStream;class ReadStreamSync extends ReadStream{[_open](){let e=!0;try{this[_onopen](null,fs_1.default.openSync(this[_path],`r`)),e=!1}finally{e&&this[_close]()}}[_read](){let e=!0;try{if(!this[_reading]){this[_reading]=!0;do{let e=this[_makeBuf](),t=e.length===0?0:fs_1.default.readSync(this[_fd],e,0,e.length,null);if(!this[_handleChunk](t,e))break}while(!0);this[_reading]=!1}e=!1}finally{e&&this[_close]()}}[_close](){if(this[_autoClose]&&typeof this[_fd]==`number`){let e=this[_fd];this[_fd]=void 0,fs_1.default.closeSync(e),this.emit(`close`)}}}exports.ReadStreamSync=ReadStreamSync;class WriteStream extends events_1.default{readable=!1;writable=!0;[_errored]=!1;[_writing]=!1;[_ended]=!1;[_queue]=[];[_needDrain]=!1;[_path];[_mode];[_autoClose];[_fd];[_defaultFlag];[_flags];[_finished]=!1;[_pos];constructor(e,t){t||={},super(t),this[_path]=e,this[_fd]=typeof t.fd==`number`?t.fd:void 0,this[_mode]=t.mode===void 0?438:t.mode,this[_pos]=typeof t.start==`number`?t.start:void 0,this[_autoClose]=typeof t.autoClose==`boolean`?t.autoClose:!0;let n=this[_pos]===void 0?`w`:`r+`;this[_defaultFlag]=t.flags===void 0,this[_flags]=t.flags===void 0?n:t.flags,this[_fd]===void 0&&this[_open]()}emit(e,...t){if(e===`error`){if(this[_errored])return!1;this[_errored]=!0}return super.emit(e,...t)}get fd(){return this[_fd]}get path(){return this[_path]}[_onerror](e){this[_close](),this[_writing]=!0,this.emit(`error`,e)}[_open](){fs_1.default.open(this[_path],this[_flags],this[_mode],(e,t)=>this[_onopen](e,t))}[_onopen](e,t){this[_defaultFlag]&&this[_flags]===`r+`&&e&&e.code===`ENOENT`?(this[_flags]=`w`,this[_open]()):e?this[_onerror](e):(this[_fd]=t,this.emit(`open`,t),this[_writing]||this[_flush]())}end(e,t){return e&&this.write(e,t),this[_ended]=!0,!this[_writing]&&!this[_queue].length&&typeof this[_fd]==`number`&&this[_onwrite](null,0),this}write(e,t){return typeof e==`string`&&(e=Buffer.from(e,t)),this[_ended]?(this.emit(`error`,Error(`write() after end()`)),!1):this[_fd]===void 0||this[_writing]||this[_queue].length?(this[_queue].push(e),this[_needDrain]=!0,!1):(this[_writing]=!0,this[_write](e),!0)}[_write](e){fs_1.default.write(this[_fd],e,0,e.length,this[_pos],(e,t)=>this[_onwrite](e,t))}[_onwrite](e,t){e?this[_onerror](e):(this[_pos]!==void 0&&typeof t==`number`&&(this[_pos]+=t),this[_queue].length?this[_flush]():(this[_writing]=!1,this[_ended]&&!this[_finished]?(this[_finished]=!0,this[_close](),this.emit(`finish`)):this[_needDrain]&&(this[_needDrain]=!1,this.emit(`drain`))))}[_flush](){if(this[_queue].length===0)this[_ended]&&this[_onwrite](null,0);else if(this[_queue].length===1)this[_write](this[_queue].pop());else{let e=this[_queue];this[_queue]=[],writev(this[_fd],e,this[_pos],(e,t)=>this[_onwrite](e,t))}}[_close](){if(this[_autoClose]&&typeof this[_fd]==`number`){let e=this[_fd];this[_fd]=void 0,fs_1.default.close(e,e=>e?this.emit(`error`,e):this.emit(`close`))}}}exports.WriteStream=WriteStream;class WriteStreamSync extends WriteStream{[_open](){let e;if(this[_defaultFlag]&&this[_flags]===`r+`)try{e=fs_1.default.openSync(this[_path],this[_flags],this[_mode])}catch(e){if(e?.code===`ENOENT`)return this[_flags]=`w`,this[_open]();throw e}else e=fs_1.default.openSync(this[_path],this[_flags],this[_mode]);this[_onopen](null,e)}[_close](){if(this[_autoClose]&&typeof this[_fd]==`number`){let e=this[_fd];this[_fd]=void 0,fs_1.default.closeSync(e),this.emit(`close`)}}[_write](e){let t=!0;try{this[_onwrite](null,fs_1.default.writeSync(this[_fd],e,0,e.length,this[_pos])),t=!1}finally{if(t)try{this[_close]()}catch{}}}}exports.WriteStreamSync=WriteStreamSync;