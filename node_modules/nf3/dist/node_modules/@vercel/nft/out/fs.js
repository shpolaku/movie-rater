"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,`__esModule`,{value:!0}),exports.CachedFileSystem=void 0;const path_1=require(`path`),graceful_fs_1=__importDefault(require(`graceful-fs`)),async_sema_1=require(`async-sema`),fsReadFile=graceful_fs_1.default.promises.readFile,fsReadlink=graceful_fs_1.default.promises.readlink,fsStat=graceful_fs_1.default.promises.stat;class CachedFileSystem{fileCache;statCache;symlinkCache;fileIOQueue;constructor({cache:e,fileIOConcurrency:t}){this.fileIOQueue=new async_sema_1.Sema(t),this.fileCache=e?.fileCache??new Map,this.statCache=e?.statCache??new Map,this.symlinkCache=e?.symlinkCache??new Map,e&&(e.fileCache=this.fileCache,e.statCache=this.statCache,e.symlinkCache=this.symlinkCache)}async readlink(e){let t=this.symlinkCache.get(e);if(t!==void 0)return t;let n=this.executeFileIO(e,this._internalReadlink);return this.symlinkCache.set(e,n),n}async readFile(e){let t=this.fileCache.get(e);if(t!==void 0)return t;let n=this.executeFileIO(e,this._internalReadFile);return this.fileCache.set(e,n),n}async stat(e){let t=this.statCache.get(e);if(t!==void 0)return t;let n=this.executeFileIO(e,this._internalStat);return this.statCache.set(e,n),n}async _internalReadlink(e){try{let n=await fsReadlink(e),r=this.statCache.get(e);return r&&this.statCache.set((0,path_1.resolve)(e,n),r),n}catch(e){if(e.code!==`EINVAL`&&e.code!==`ENOENT`&&e.code!==`UNKNOWN`)throw e;return null}}async _internalReadFile(e){try{return(await fsReadFile(e)).toString()}catch(e){if(e.code===`ENOENT`||e.code===`EISDIR`)return null;throw e}}async _internalStat(e){try{return await fsStat(e)}catch(e){if(e.code===`ENOENT`)return null;throw e}}async executeFileIO(e,t){await this.fileIOQueue.acquire();try{return t.call(this,e)}finally{this.fileIOQueue.release()}}}exports.CachedFileSystem=CachedFileSystem;