"use strict";var __createBinding=this&&this.__createBinding||(Object.create?(function(e,t,n,r){r===void 0&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);(!i||(`get`in i?!t.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}):(function(e,t,n,r){r===void 0&&(r=n),e[r]=t[n]})),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?(function(e,t){Object.defineProperty(e,`default`,{enumerable:!0,value:t})}):function(e,t){e.default=t}),__importStar=this&&this.__importStar||(function(){var n=function(e){return n=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},n(e)};return function(r){if(r&&r.__esModule)return r;var i={};if(r!=null)for(var a=n(r),o=0;o<a.length;o++)a[o]!==`default`&&__createBinding(i,r,a[o]);return __setModuleDefault(i,r),i}})(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,`__esModule`,{value:!0}),exports.Job=void 0,exports.nodeFileTrace=nodeFileTrace;const path_1=require(`path`),analyze_1=__importDefault(require(`./analyze`)),resolve_dependency_1=__importStar(require(`./resolve-dependency`)),picomatch_1=require(`picomatch`),sharedlib_emit_1=require(`./utils/sharedlib-emit`),fs_1=require(`./fs`);function inPath(e,t){let n=(0,path_1.join)(t,path_1.sep);return e.startsWith(n)&&e!==n}async function nodeFileTrace(e,t={}){let n=new Job(t);return t.readFile&&(n.readFile=t.readFile),t.stat&&(n.stat=t.stat),t.readlink&&(n.readlink=t.readlink),t.resolve&&(n.resolve=t.resolve),n.ts=!0,await Promise.all(e.map(async e=>{let t=(0,path_1.resolve)(e);return await n.emitFile(t,`initial`),n.emitDependency(t)})),{fileList:n.fileList,esmFileList:n.esmFileList,reasons:n.reasons,warnings:n.warnings}}class Job{ts;base;cwd;conditions;exportsOnly;paths;ignoreFn;log;depth;mixedModules;analysis;analysisCache;fileList;esmFileList;processed;warnings;reasons=new Map;cachedFileSystem;remappings=new Map;constructor({base:e=process.cwd(),processCwd:t,exports:n,conditions:r=n||[`node`],exportsOnly:a=!1,paths:o={},ignore:c,log:u=!1,mixedModules:d=!1,ts:f=!0,analysis:p={},cache:m,fileIOConcurrency:h=1024,depth:g=1/0}){if(this.ts=f,e=(0,path_1.resolve)(e),this.ignoreFn=e=>!!e.startsWith(`..`+path_1.sep),typeof c==`string`&&(c=[c]),typeof c==`function`){let e=c;this.ignoreFn=t=>!!(t.startsWith(`..`+path_1.sep)||e(t))}else if(Array.isArray(c)){let t=c.map(t=>(0,path_1.relative)(e,(0,path_1.resolve)(e||process.cwd(),t)));this.ignoreFn=e=>!!(e.startsWith(`..`+path_1.sep)||(0,picomatch_1.isMatch)(e,t))}this.base=e,this.cwd=(0,path_1.resolve)(t||e),this.conditions=r,this.exportsOnly=a;let _={};for(let t of Object.keys(o)){let n=o[t].endsWith(`/`);_[t]=(0,path_1.resolve)(e,o[t])+(n?`/`:``)}this.paths=_,this.log=u,this.depth=g,this.mixedModules=d,this.cachedFileSystem=new fs_1.CachedFileSystem({cache:m,fileIOConcurrency:h}),this.analysis={},p!==!1&&Object.assign(this.analysis,{emitGlobs:!0,computeFileReferences:!0,evaluatePureExpressions:!0},p===!0?{}:p),this.analysisCache=m&&m.analysisCache||new Map,m&&(m.analysisCache=this.analysisCache),this.fileList=new Set,this.esmFileList=new Set,this.processed=new Set,this.warnings=new Set}addRemapping(e,t){if(e===t)return;let n=this.remappings.get(e);n||(n=new Set,this.remappings.set(e,n)),n.add(t)}async readlink(e){return this.cachedFileSystem.readlink(e)}async isFile(e){let t=await this.stat(e);return t?t.isFile():!1}async isDir(e){let t=await this.stat(e);return t?t.isDirectory():!1}async stat(e){return this.cachedFileSystem.stat(e)}maybeEmitDep=async(e,t,n,r)=>{let i=``,a;try{i=await this.resolve(e,t,this,n)}catch(r){a=r;try{if(this.ts&&e.endsWith(`.js`)&&r instanceof resolve_dependency_1.NotFoundError){let r=e.slice(0,-3)+`.ts`;i=await this.resolve(r,t,this,n),a=void 0}}catch(e){a=e}}if(a){this.warnings.add(Error(`Failed to resolve dependency "${e}":\n${a?.message}`));return}if(Array.isArray(i))for(let e of i){if(e.startsWith(`node:`))return;await this.emitDependency(e,t,r)}else{if(i.startsWith(`node:`))return;await this.emitDependency(i,t,r)}};async resolve(e,t,n,r){return(0,resolve_dependency_1.default)(e,t,n,r)}async readFile(e){return this.cachedFileSystem.readFile(e)}async realpath(e,t,n=new Set){if(n.has(e))throw Error(`Recursive symlink detected resolving `+e);n.add(e);let r=await this.readlink(e);if(r){let a=(0,path_1.dirname)(e),o=(0,path_1.resolve)(a,r);return inPath(e,await this.realpath(a,t))&&await this.emitFile(e,`resolve`,t,!0),this.realpath(o,t,n)}return inPath(e,this.base)?(0,path_1.join)(await this.realpath((0,path_1.dirname)(e),t,n),(0,path_1.basename)(e)):e}async emitFile(e,t,n,r=!1){r||(e=await this.realpath(e,n)),e=(0,path_1.relative)(this.base,e),n&&=(0,path_1.relative)(this.base,n);let a=this.reasons.get(e);return a?a.type.includes(t)||a.type.push(t):(a={type:[t],ignored:!1,parents:new Set},this.reasons.set(e,a)),n&&this.ignoreFn(e,n)?(!this.fileList.has(e)&&a&&(a.ignored=!0),!1):(n&&a.parents.add(n),this.fileList.add(e),!0)}async getPjsonBoundary(e){let t=e.indexOf(path_1.sep),n;for(;(n=e.lastIndexOf(path_1.sep))>t;)if(e=e.slice(0,n),await this.isFile(e+path_1.sep+`package.json`))return e}async emitDependency(e,t,n=this.depth){if(n<0)throw Error(`invariant - depth option cannot be negative`);if(this.processed.has(e)){t&&await this.emitFile(e,`dependency`,t);return}this.processed.add(e);let r=this.remappings.get(e);if(r&&await Promise.all([...r].map(async t=>this.emitDependency(t,e,n))),!await this.emitFile(e,`dependency`,t)||e.endsWith(`.json`))return;if(e.endsWith(`.node`))return await(0,sharedlib_emit_1.sharedLibEmit)(e,this);if(e.endsWith(`.js`)||e.endsWith(`.ts`)){let t=await this.getPjsonBoundary(e);t&&await this.emitFile(t+path_1.sep+`package.json`,`resolve`,e)}if(n===0)return;let o,s=this.analysisCache.get(e);if(s)o=s;else{let t=await this.readFile(e);if(t===null)throw Error(`File `+e+` does not exist.`);o=await(0,analyze_1.default)(e,t.toString(),this),this.analysisCache.set(e,o)}let{deps:l,imports:u,assets:d,isESM:f}=o;f&&this.esmFileList.add((0,path_1.relative)(this.base,e)),await Promise.all([...[...d].map(async t=>{let r=(0,path_1.extname)(t);r===`.js`||r===`.mjs`||r===`.node`||r===``||this.ts&&(r===`.ts`||r===`.tsx`)&&t.startsWith(this.base)&&t.slice(this.base.length).indexOf(path_1.sep+`node_modules`+path_1.sep)===-1?await this.emitDependency(t,e,n-1):await this.emitFile(t,`asset`,e)}),...[...l].map(async t=>this.maybeEmitDep(t,e,!f,n-1)),...[...u].map(async t=>this.maybeEmitDep(t,e,!1,n-1))])}}exports.Job=Job;