"use strict";Object.defineProperty(exports,`__esModule`,{value:!0}),exports.wildcardRegEx=exports.WILDCARD=exports.FUNCTION=exports.UNKNOWN=void 0,exports.evaluate=evaluate;async function evaluate(e,t={},r=!0){let i={computeBranches:r,vars:t};return a(e);function a(e){let t=visitors[e.type];if(t)return t.call(i,e,a)}}exports.UNKNOWN=Symbol(),exports.FUNCTION=Symbol(),exports.WILDCARD=``,exports.wildcardRegEx=/\x1a/g;function countWildcards(e){exports.wildcardRegEx.lastIndex=0;let t=0;for(;exports.wildcardRegEx.exec(e);)t++;return t}const visitors={ArrayExpression:async function(e,t){let n=[];for(let r=0,i=e.elements.length;r<i;r++){if(e.elements[r]===null){n.push(null);continue}let i=await t(e.elements[r]);if(!i||!(`value`in i))return;n.push(i.value)}return{value:n}},ArrowFunctionExpression:async function(e,t){if(e.params.length===0&&!e.generator&&!e.async&&e.expression){let n=await t(e.body);return!n||!(`value`in n)?void 0:{value:{[exports.FUNCTION]:()=>n.value}}}},BinaryExpression:async function(e,t){let n=e.operator,r=await t(e.left);if(!r&&n!==`+`)return;let i=await t(e.right);if(!(!r&&!i)){if(!r)return this.computeBranches&&i&&`value`in i&&typeof i.value==`string`?{value:exports.WILDCARD+i.value,wildcards:[e.left,...i.wildcards||[]]}:void 0;if(!i)return this.computeBranches&&n===`+`&&r&&`value`in r&&typeof r.value==`string`?{value:r.value+exports.WILDCARD,wildcards:[...r.wildcards||[],e.right]}:!(`test`in r)&&n===`||`&&r.value?r:void 0;if(`test`in r&&`value`in i){let e=i.value;if(n===`==`)return{test:r.test,ifTrue:r.ifTrue==e,else:r.else==e};if(n===`===`)return{test:r.test,ifTrue:r.ifTrue===e,else:r.else===e};if(n===`!=`)return{test:r.test,ifTrue:r.ifTrue!=e,else:r.else!=e};if(n===`!==`)return{test:r.test,ifTrue:r.ifTrue!==e,else:r.else!==e};if(n===`+`)return{test:r.test,ifTrue:r.ifTrue+e,else:r.else+e};if(n===`-`)return{test:r.test,ifTrue:r.ifTrue-e,else:r.else-e};if(n===`*`)return{test:r.test,ifTrue:r.ifTrue*e,else:r.else*e};if(n===`/`)return{test:r.test,ifTrue:r.ifTrue/e,else:r.else/e};if(n===`%`)return{test:r.test,ifTrue:r.ifTrue%e,else:r.else%e};if(n===`<`)return{test:r.test,ifTrue:r.ifTrue<e,else:r.else<e};if(n===`<=`)return{test:r.test,ifTrue:r.ifTrue<=e,else:r.else<=e};if(n===`>`)return{test:r.test,ifTrue:r.ifTrue>e,else:r.else>e};if(n===`>=`)return{test:r.test,ifTrue:r.ifTrue>=e,else:r.else>=e};if(n===`|`)return{test:r.test,ifTrue:r.ifTrue|e,else:r.else|e};if(n===`&`)return{test:r.test,ifTrue:r.ifTrue&e,else:r.else&e};if(n===`^`)return{test:r.test,ifTrue:r.ifTrue^e,else:r.else^e};if(n===`&&`)return{test:r.test,ifTrue:r.ifTrue&&e,else:r.else&&e};if(n===`||`)return{test:r.test,ifTrue:r.ifTrue||e,else:r.else||e}}else if(`test`in i&&`value`in r){let e=r.value;if(n===`==`)return{test:i.test,ifTrue:e==i.ifTrue,else:e==i.else};if(n===`===`)return{test:i.test,ifTrue:e===i.ifTrue,else:e===i.else};if(n===`!=`)return{test:i.test,ifTrue:e!=i.ifTrue,else:e!=i.else};if(n===`!==`)return{test:i.test,ifTrue:e!==i.ifTrue,else:e!==i.else};if(n===`+`)return{test:i.test,ifTrue:e+i.ifTrue,else:e+i.else};if(n===`-`)return{test:i.test,ifTrue:e-i.ifTrue,else:e-i.else};if(n===`*`)return{test:i.test,ifTrue:e*i.ifTrue,else:e*i.else};if(n===`/`)return{test:i.test,ifTrue:e/i.ifTrue,else:e/i.else};if(n===`%`)return{test:i.test,ifTrue:e%i.ifTrue,else:e%i.else};if(n===`<`)return{test:i.test,ifTrue:e<i.ifTrue,else:e<i.else};if(n===`<=`)return{test:i.test,ifTrue:e<=i.ifTrue,else:e<=i.else};if(n===`>`)return{test:i.test,ifTrue:e>i.ifTrue,else:e>i.else};if(n===`>=`)return{test:i.test,ifTrue:e>=i.ifTrue,else:e>=i.else};if(n===`|`)return{test:i.test,ifTrue:e|i.ifTrue,else:e|i.else};if(n===`&`)return{test:i.test,ifTrue:e&i.ifTrue,else:e&i.else};if(n===`^`)return{test:i.test,ifTrue:e^i.ifTrue,else:e^i.else};if(n===`&&`)return{test:i.test,ifTrue:e&&i.ifTrue,else:r&&i.else};if(n===`||`)return{test:i.test,ifTrue:e||i.ifTrue,else:r||i.else}}else if(`value`in r&&`value`in i){if(n===`==`)return{value:r.value==i.value};if(n===`===`)return{value:r.value===i.value};if(n===`!=`)return{value:r.value!=i.value};if(n===`!==`)return{value:r.value!==i.value};if(n===`+`){let e={value:r.value+i.value},t=[];return`wildcards`in r&&r.wildcards&&(t=t.concat(r.wildcards)),`wildcards`in i&&i.wildcards&&(t=t.concat(i.wildcards)),t.length>0&&(e.wildcards=t),e}if(n===`-`)return{value:r.value-i.value};if(n===`*`)return{value:r.value*i.value};if(n===`/`)return{value:r.value/i.value};if(n===`%`)return{value:r.value%i.value};if(n===`<`)return{value:r.value<i.value};if(n===`<=`)return{value:r.value<=i.value};if(n===`>`)return{value:r.value>i.value};if(n===`>=`)return{value:r.value>=i.value};if(n===`|`)return{value:r.value|i.value};if(n===`&`)return{value:r.value&i.value};if(n===`^`)return{value:r.value^i.value};if(n===`&&`)return{value:r.value&&i.value};if(n===`||`)return{value:r.value||i.value}}}},CallExpression:async function(e,n){let r=await n(e.callee);if(!r||`test`in r)return;let i=r.value;if(typeof i==`object`&&i&&(i=i[exports.FUNCTION]),typeof i!=`function`)return;let a=null;e.callee.object&&(a=await n(e.callee.object),a=a&&`value`in a&&a.value?a.value:null);let o,s=[],c,l=e.arguments.length>0&&e.callee.property?.name!==`concat`,u=[];for(let t=0,r=e.arguments.length;t<r;t++){let r=await n(e.arguments[t]);if(r)l=!1,`value`in r&&typeof r.value==`string`&&r.wildcards&&r.wildcards.forEach(e=>u.push(e));else{if(!this.computeBranches)return;r={value:exports.WILDCARD},u.push(e.arguments[t])}if(`test`in r){if(u.length||o)return;o=r.test,c=s.concat([]),s.push(r.ifTrue),c.push(r.else)}else s.push(r.value),c&&c.push(r.value)}if(!l)try{let e=await i.apply(a,s);if(e===exports.UNKNOWN)return;if(!o)return u.length?typeof e!=`string`||countWildcards(e)!==u.length?void 0:{value:e,wildcards:u}:{value:e};let n=await i.apply(a,c);return e===exports.UNKNOWN?void 0:{test:o,ifTrue:e,else:n}}catch{return}},ConditionalExpression:async function(e,t){let n=await t(e.test);if(n&&`value`in n)return n.value?t(e.consequent):t(e.alternate);if(!this.computeBranches)return;let r=await t(e.consequent);if(!r||`wildcards`in r||`test`in r)return;let i=await t(e.alternate);if(!(!i||`wildcards`in i||`test`in i))return{test:e.test,ifTrue:r.value,else:i.value}},ExpressionStatement:async function(e,t){return t(e.expression)},Identifier:async function(e,t){if(Object.hasOwnProperty.call(this.vars,e.name))return this.vars[e.name]},Literal:async function(e,t){return{value:e.value}},MemberExpression:async function(e,t){let n=await t(e.object);if(!n||`test`in n||typeof n.value==`function`)return;if(e.property.type===`Identifier`){if(typeof n.value==`string`&&e.property.name===`concat`)return{value:{[exports.FUNCTION]:(...e)=>n.value.concat(e)}};if(typeof n.value==`object`&&n.value!==null){let r=n.value;if(e.computed){let i=await t(e.property);if(i&&`value`in i&&i.value){let e=r[i.value];return e===exports.UNKNOWN?void 0:{value:e}}if(!r[exports.UNKNOWN]&&Object.keys(n).length===0)return{value:void 0}}else if(e.property.name in r){let t=r[e.property.name];return t===exports.UNKNOWN?void 0:{value:t}}else if(r[exports.UNKNOWN])return}else return{value:void 0}}let r=await t(e.property);if(!(!r||`test`in r))if(typeof n.value==`object`&&n.value!==null){if(r.value in n.value){let e=n.value[r.value];return e===exports.UNKNOWN?void 0:{value:e}}else if(n.value[exports.UNKNOWN])return}else return{value:void 0}},MetaProperty:async function(e){if(e.meta.name===`import`&&e.property.name===`meta`)return{value:this.vars[`import.meta`]}},NewExpression:async function(e,t){let n=await t(e.callee);if(n&&`value`in n&&n.value===URL&&e.arguments.length){let n=await t(e.arguments[0]);if(!n)return;let r=null;if(e.arguments[1]&&(r=await t(e.arguments[1]),!r||!(`value`in r)))return;if(`value`in n){if(r)try{return{value:new URL(n.value,r.value)}}catch{return}try{return{value:new URL(n.value)}}catch{return}}else{let e=n.test;if(r)try{return{test:e,ifTrue:new URL(n.ifTrue,r.value),else:new URL(n.else,r.value)}}catch{return}try{return{test:e,ifTrue:new URL(n.ifTrue),else:new URL(n.else)}}catch{return}}}},ObjectExpression:async function(e,t){let n={};for(let r=0;r<e.properties.length;r++){let i=e.properties[r],a=i.computed?t(i.key):i.key&&{value:i.key.name||i.key.value};if(!a||`test`in a)return;let o=await t(i.value);if(!o||`test`in o||o.value===exports.UNKNOWN)return;n[a.value]=o.value}return{value:n}},SequenceExpression:async function(e,t){if(`expressions`in e&&e.expressions.length===2&&e.expressions[0].type===`Literal`&&e.expressions[0].value===0&&e.expressions[1].type===`MemberExpression`)return await t(e.expressions[1])},TemplateLiteral:async function(e,t){let n={value:``};for(var r=0;r<e.expressions.length;r++){`value`in n?n.value+=e.quasis[r].value.cooked:(n.ifTrue+=e.quasis[r].value.cooked,n.else+=e.quasis[r].value.cooked);let i=await t(e.expressions[r]);if(!i){if(!this.computeBranches)return;i={value:exports.WILDCARD,wildcards:[e.expressions[r]]}}if(`value`in i)if(`value`in n)n.value+=i.value,i.wildcards&&(n.wildcards=[...n.wildcards||[],...i.wildcards]);else{if(i.wildcards)return;n.ifTrue+=i.value,n.else+=i.value}else if(`value`in n){if(`wildcards`in n)return;n={test:i.test,ifTrue:n.value+i.ifTrue,else:n.value+i.else}}else return}return`value`in n?n.value+=e.quasis[r].value.cooked:(n.ifTrue+=e.quasis[r].value.cooked,n.else+=e.quasis[r].value.cooked),n},ThisExpression:async function(e,t){if(Object.hasOwnProperty.call(this.vars,`this`))return this.vars.this},UnaryExpression:async function(e,t){let n=await t(e.argument);if(n){if(`value`in n&&!(`wildcards`in n)){if(e.operator===`+`)return{value:+n.value};if(e.operator===`-`)return{value:-n.value};if(e.operator===`~`)return{value:~n.value};if(e.operator===`!`)return{value:!n.value}}else if(`test`in n&&!(`wildcards`in n)){if(e.operator===`+`)return{test:n.test,ifTrue:+n.ifTrue,else:+n.else};if(e.operator===`-`)return{test:n.test,ifTrue:-n.ifTrue,else:-n.else};if(e.operator===`~`)return{test:n.test,ifTrue:~n.ifTrue,else:~n.else};if(e.operator===`!`)return{test:n.test,ifTrue:!n.ifTrue,else:!n.else}}}}};visitors.LogicalExpression=visitors.BinaryExpression;