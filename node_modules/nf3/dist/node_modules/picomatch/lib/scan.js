"use strict";const utils=require(`./utils`),{CHAR_ASTERISK,CHAR_AT,CHAR_BACKWARD_SLASH,CHAR_COMMA,CHAR_DOT,CHAR_EXCLAMATION_MARK,CHAR_FORWARD_SLASH,CHAR_LEFT_CURLY_BRACE,CHAR_LEFT_PARENTHESES,CHAR_LEFT_SQUARE_BRACKET,CHAR_PLUS,CHAR_QUESTION_MARK,CHAR_RIGHT_CURLY_BRACE,CHAR_RIGHT_PARENTHESES,CHAR_RIGHT_SQUARE_BRACKET}=require(`./constants`),isPathSeparator=e=>e===CHAR_FORWARD_SLASH||e===CHAR_BACKWARD_SLASH,depth=e=>{e.isPrefix!==!0&&(e.depth=e.isGlobstar?1/0:1)},scan=(a,o)=>{let s=o||{},c=a.length-1,l=s.parts===!0||s.scanToEnd===!0,u=[],d=[],f=[],p=a,m=-1,h=0,g=0,_=!1,v=!1,y=!1,b=!1,x=!1,S=!1,C=!1,w=!1,T=!1,E=!1,D=0,O,k,A={value:``,depth:0,isGlob:!1},j=()=>m>=c,M=()=>p.charCodeAt(m+1),N=()=>(O=k,p.charCodeAt(++m));for(;m<c;){k=N();let e;if(k===CHAR_BACKWARD_SLASH){C=A.backslashes=!0,k=N(),k===CHAR_LEFT_CURLY_BRACE&&(S=!0);continue}if(S===!0||k===CHAR_LEFT_CURLY_BRACE){for(D++;j()!==!0&&(k=N());){if(k===CHAR_BACKWARD_SLASH){C=A.backslashes=!0,N();continue}if(k===CHAR_LEFT_CURLY_BRACE){D++;continue}if(S!==!0&&k===CHAR_DOT&&(k=N())===CHAR_DOT){if(_=A.isBrace=!0,y=A.isGlob=!0,E=!0,l===!0)continue;break}if(S!==!0&&k===CHAR_COMMA){if(_=A.isBrace=!0,y=A.isGlob=!0,E=!0,l===!0)continue;break}if(k===CHAR_RIGHT_CURLY_BRACE&&(D--,D===0)){S=!1,_=A.isBrace=!0,E=!0;break}}if(l===!0)continue;break}if(k===CHAR_FORWARD_SLASH){if(u.push(m),d.push(A),A={value:``,depth:0,isGlob:!1},E===!0)continue;if(O===CHAR_DOT&&m===h+1){h+=2;continue}g=m+1;continue}if(s.noext!==!0&&(k===CHAR_PLUS||k===CHAR_AT||k===CHAR_ASTERISK||k===CHAR_QUESTION_MARK||k===CHAR_EXCLAMATION_MARK)&&M()===CHAR_LEFT_PARENTHESES){if(y=A.isGlob=!0,b=A.isExtglob=!0,E=!0,k===CHAR_EXCLAMATION_MARK&&m===h&&(T=!0),l===!0){for(;j()!==!0&&(k=N());){if(k===CHAR_BACKWARD_SLASH){C=A.backslashes=!0,k=N();continue}if(k===CHAR_RIGHT_PARENTHESES){y=A.isGlob=!0,E=!0;break}}continue}break}if(k===CHAR_ASTERISK){if(O===CHAR_ASTERISK&&(x=A.isGlobstar=!0),y=A.isGlob=!0,E=!0,l===!0)continue;break}if(k===CHAR_QUESTION_MARK){if(y=A.isGlob=!0,E=!0,l===!0)continue;break}if(k===CHAR_LEFT_SQUARE_BRACKET){for(;j()!==!0&&(e=N());){if(e===CHAR_BACKWARD_SLASH){C=A.backslashes=!0,N();continue}if(e===CHAR_RIGHT_SQUARE_BRACKET){v=A.isBracket=!0,y=A.isGlob=!0,E=!0;break}}if(l===!0)continue;break}if(s.nonegate!==!0&&k===CHAR_EXCLAMATION_MARK&&m===h){w=A.negated=!0,h++;continue}if(s.noparen!==!0&&k===CHAR_LEFT_PARENTHESES){if(y=A.isGlob=!0,l===!0){for(;j()!==!0&&(k=N());){if(k===CHAR_LEFT_PARENTHESES){C=A.backslashes=!0,k=N();continue}if(k===CHAR_RIGHT_PARENTHESES){E=!0;break}}continue}break}if(y===!0){if(E=!0,l===!0)continue;break}}s.noext===!0&&(b=!1,y=!1);let P=p,F=``,I=``;h>0&&(F=p.slice(0,h),p=p.slice(h),g-=h),P&&y===!0&&g>0?(P=p.slice(0,g),I=p.slice(g)):y===!0?(P=``,I=p):P=p,P&&P!==``&&P!==`/`&&P!==p&&isPathSeparator(P.charCodeAt(P.length-1))&&(P=P.slice(0,-1)),s.unescape===!0&&(I&&=utils.removeBackslashes(I),P&&C===!0&&(P=utils.removeBackslashes(P)));let L={prefix:F,input:a,start:h,base:P,glob:I,isBrace:_,isBracket:v,isGlob:y,isExtglob:b,isGlobstar:x,negated:w,negatedExtglob:T};if(s.tokens===!0&&(L.maxDepth=0,isPathSeparator(k)||d.push(A),L.tokens=d),s.parts===!0||s.tokens===!0){let e;for(let t=0;t<u.length;t++){let n=e?e+1:h,r=u[t],i=a.slice(n,r);s.tokens&&(t===0&&h!==0?(d[t].isPrefix=!0,d[t].value=F):d[t].value=i,depth(d[t]),L.maxDepth+=d[t].depth),(t!==0||i!==``)&&f.push(i),e=r}if(e&&e+1<a.length){let t=a.slice(e+1);f.push(t),s.tokens&&(d[d.length-1].value=t,depth(d[d.length-1]),L.maxDepth+=d[d.length-1].depth)}L.slashes=u,L.parts=f}return L};module.exports=scan;