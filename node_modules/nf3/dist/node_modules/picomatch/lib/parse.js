"use strict";const constants=require(`./constants`),utils=require(`./utils`),{MAX_LENGTH,POSIX_REGEX_SOURCE,REGEX_NON_SPECIAL_CHARS,REGEX_SPECIAL_CHARS_BACKREF,REPLACEMENTS}=constants,expandRange=(e,n)=>{if(typeof n.expandRange==`function`)return n.expandRange(...e,n);e.sort();let r=`[${e.join(`-`)}]`;try{new RegExp(r)}catch{return e.map(e=>utils.escapeRegex(e)).join(`..`)}return r},syntaxError=(e,t)=>`Missing ${e}: "${t}" - use "\\\\${t}" to match literal characters`,parse=(u,d)=>{if(typeof u!=`string`)throw TypeError(`Expected a string`);u=REPLACEMENTS[u]||u;let f={...d},p=typeof f.maxLength==`number`?Math.min(MAX_LENGTH,f.maxLength):MAX_LENGTH,m=u.length;if(m>p)throw SyntaxError(`Input length: ${m}, exceeds maximum allowed length: ${p}`);let h={type:`bos`,value:``,output:f.prepend||``},g=[h],_=f.capture?``:`?:`,v=constants.globChars(f.windows),y=constants.extglobChars(v),{DOT_LITERAL:b,PLUS_LITERAL:x,SLASH_LITERAL:S,ONE_CHAR:C,DOTS_SLASH:w,NO_DOT:T,NO_DOT_SLASH:E,NO_DOTS_SLASH:D,QMARK:O,QMARK_NO_DOT:k,STAR:A,START_ANCHOR:j}=v,M=e=>`(${_}(?:(?!${j}${e.dot?w:b}).)*?)`,N=f.dot?``:T,P=f.dot?O:k,F=f.bash===!0?M(f):A;f.capture&&(F=`(${F})`),typeof f.noext==`boolean`&&(f.noextglob=f.noext);let I={input:u,index:-1,start:0,dot:f.dot===!0,consumed:``,output:``,prefix:``,backtrack:!1,negated:!1,brackets:0,braces:0,parens:0,quotes:0,globstar:!1,tokens:g};u=utils.removePrefix(u,I),m=u.length;let L=[],R=[],z=[],B=h,V,H=()=>I.index===m-1,U=I.peek=(e=1)=>u[I.index+e],W=I.advance=()=>u[++I.index]||``,G=()=>u.slice(I.index+1),K=(e=``,t=0)=>{I.consumed+=e,I.index+=t},q=e=>{I.output+=e.output==null?e.value:e.output,K(e.value)},J=()=>{let e=1;for(;U()===`!`&&(U(2)!==`(`||U(3)===`?`);)W(),I.start++,e++;return e%2==0?!1:(I.negated=!0,I.start++,!0)},Y=e=>{I[e]++,z.push(e)},X=e=>{I[e]--,z.pop()},Z=e=>{if(B.type===`globstar`){let t=I.braces>0&&(e.type===`comma`||e.type===`brace`),n=e.extglob===!0||L.length&&(e.type===`pipe`||e.type===`paren`);e.type!==`slash`&&e.type!==`paren`&&!t&&!n&&(I.output=I.output.slice(0,-B.output.length),B.type=`star`,B.value=`*`,B.output=F,I.output+=B.output)}if(L.length&&e.type!==`paren`&&(L[L.length-1].inner+=e.value),(e.value||e.output)&&q(e),B&&B.type===`text`&&e.type===`text`){B.output=(B.output||B.value)+e.value,B.value+=e.value;return}e.prev=B,g.push(e),B=e},Q=(e,t)=>{let n={...y[t],conditions:1,inner:``};n.prev=B,n.parens=I.parens,n.output=I.output;let r=(f.capture?`(`:``)+n.open;Y(`parens`),Z({type:e,value:t,output:I.output?``:C}),Z({type:`paren`,extglob:!0,value:W(),output:r}),L.push(n)},$=e=>{let t=e.close+(f.capture?`)`:``),n;if(e.type===`negate`){let r=F;e.inner&&e.inner.length>1&&e.inner.includes(`/`)&&(r=M(f)),(r!==F||H()||/^\)+$/.test(G()))&&(t=e.close=`)$))${r}`),e.inner.includes(`*`)&&(n=G())&&/^\.[^\\/.]+$/.test(n)&&(t=e.close=`)${parse(n,{...d,fastpaths:!1}).output})${r})`),e.prev.type===`bos`&&(I.negatedExtglob=!0)}Z({type:`paren`,extglob:!0,value:V,output:t}),X(`parens`)};if(f.fastpaths!==!1&&!/(^[*!]|[/()[\]{}"])/.test(u)){let e=!1,n=u.replace(REGEX_SPECIAL_CHARS_BACKREF,(t,n,r,i,a,o)=>i===`\\`?(e=!0,t):i===`?`?n?n+i+(a?O.repeat(a.length):``):o===0?P+(a?O.repeat(a.length):``):O.repeat(r.length):i===`.`?b.repeat(r.length):i===`*`?n?n+i+(a?F:``):F:n?t:`\\${t}`);return e===!0&&(n=f.unescape===!0?n.replace(/\\/g,``):n.replace(/\\+/g,e=>e.length%2==0?`\\\\`:e?`\\`:``)),n===u&&f.contains===!0?(I.output=u,I):(I.output=utils.wrapOutput(n,I,d),I)}for(;!H();){if(V=W(),V===`\0`)continue;if(V===`\\`){let e=U();if(e===`/`&&f.bash!==!0||e===`.`||e===`;`)continue;if(!e){V+=`\\`,Z({type:`text`,value:V});continue}let t=/^\\+/.exec(G()),n=0;if(t&&t[0].length>2&&(n=t[0].length,I.index+=n,n%2!=0&&(V+=`\\`)),f.unescape===!0?V=W():V+=W(),I.brackets===0){Z({type:`text`,value:V});continue}}if(I.brackets>0&&(V!==`]`||B.value===`[`||B.value===`[^`)){if(f.posix!==!1&&V===`:`){let e=B.value.slice(1);if(e.includes(`[`)&&(B.posix=!0,e.includes(`:`))){let e=B.value.lastIndexOf(`[`),t=B.value.slice(0,e),n=POSIX_REGEX_SOURCE[B.value.slice(e+2)];if(n){B.value=t+n,I.backtrack=!0,W(),!h.output&&g.indexOf(B)===1&&(h.output=C);continue}}}(V===`[`&&U()!==`:`||V===`-`&&U()===`]`)&&(V=`\\${V}`),V===`]`&&(B.value===`[`||B.value===`[^`)&&(V=`\\${V}`),f.posix===!0&&V===`!`&&B.value===`[`&&(V=`^`),B.value+=V,q({value:V});continue}if(I.quotes===1&&V!==`"`){V=utils.escapeRegex(V),B.value+=V,q({value:V});continue}if(V===`"`){I.quotes=I.quotes===1?0:1,f.keepQuotes===!0&&Z({type:`text`,value:V});continue}if(V===`(`){Y(`parens`),Z({type:`paren`,value:V});continue}if(V===`)`){if(I.parens===0&&f.strictBrackets===!0)throw SyntaxError(syntaxError(`opening`,`(`));let e=L[L.length-1];if(e&&I.parens===e.parens+1){$(L.pop());continue}Z({type:`paren`,value:V,output:I.parens?`)`:`\\)`}),X(`parens`);continue}if(V===`[`){if(f.nobracket===!0||!G().includes(`]`)){if(f.nobracket!==!0&&f.strictBrackets===!0)throw SyntaxError(syntaxError(`closing`,`]`));V=`\\${V}`}else Y(`brackets`);Z({type:`bracket`,value:V});continue}if(V===`]`){if(f.nobracket===!0||B&&B.type===`bracket`&&B.value.length===1){Z({type:`text`,value:V,output:`\\${V}`});continue}if(I.brackets===0){if(f.strictBrackets===!0)throw SyntaxError(syntaxError(`opening`,`[`));Z({type:`text`,value:V,output:`\\${V}`});continue}X(`brackets`);let e=B.value.slice(1);if(B.posix!==!0&&e[0]===`^`&&!e.includes(`/`)&&(V=`/${V}`),B.value+=V,q({value:V}),f.literalBrackets===!1||utils.hasRegexChars(e))continue;let n=utils.escapeRegex(B.value);if(I.output=I.output.slice(0,-B.value.length),f.literalBrackets===!0){I.output+=n,B.value=n;continue}B.value=`(${_}${n}|${B.value})`,I.output+=B.value;continue}if(V===`{`&&f.nobrace!==!0){Y(`braces`);let e={type:`brace`,value:V,output:`(`,outputIndex:I.output.length,tokensIndex:I.tokens.length};R.push(e),Z(e);continue}if(V===`}`){let e=R[R.length-1];if(f.nobrace===!0||!e){Z({type:`text`,value:V,output:V});continue}let t=`)`;if(e.dots===!0){let e=g.slice(),n=[];for(let t=e.length-1;t>=0&&(g.pop(),e[t].type!==`brace`);t--)e[t].type!==`dots`&&n.unshift(e[t].value);t=expandRange(n,f),I.backtrack=!0}if(e.comma!==!0&&e.dots!==!0){let n=I.output.slice(0,e.outputIndex),r=I.tokens.slice(e.tokensIndex);e.value=e.output=`\\{`,V=t=`\\}`,I.output=n;for(let e of r)I.output+=e.output||e.value}Z({type:`brace`,value:V,output:t}),X(`braces`),R.pop();continue}if(V===`|`){L.length>0&&L[L.length-1].conditions++,Z({type:`text`,value:V});continue}if(V===`,`){let e=V,t=R[R.length-1];t&&z[z.length-1]===`braces`&&(t.comma=!0,e=`|`),Z({type:`comma`,value:V,output:e});continue}if(V===`/`){if(B.type===`dot`&&I.index===I.start+1){I.start=I.index+1,I.consumed=``,I.output=``,g.pop(),B=h;continue}Z({type:`slash`,value:V,output:S});continue}if(V===`.`){if(I.braces>0&&B.type===`dot`){B.value===`.`&&(B.output=b);let e=R[R.length-1];B.type=`dots`,B.output+=V,B.value+=V,e.dots=!0;continue}if(I.braces+I.parens===0&&B.type!==`bos`&&B.type!==`slash`){Z({type:`text`,value:V,output:b});continue}Z({type:`dot`,value:V,output:b});continue}if(V===`?`){if(!(B&&B.value===`(`)&&f.noextglob!==!0&&U()===`(`&&U(2)!==`?`){Q(`qmark`,V);continue}if(B&&B.type===`paren`){let e=U(),t=V;(B.value===`(`&&!/[!=<:]/.test(e)||e===`<`&&!/<([!=]|\w+>)/.test(G()))&&(t=`\\${V}`),Z({type:`text`,value:V,output:t});continue}if(f.dot!==!0&&(B.type===`slash`||B.type===`bos`)){Z({type:`qmark`,value:V,output:k});continue}Z({type:`qmark`,value:V,output:O});continue}if(V===`!`){if(f.noextglob!==!0&&U()===`(`&&(U(2)!==`?`||!/[!=<:]/.test(U(3)))){Q(`negate`,V);continue}if(f.nonegate!==!0&&I.index===0){J();continue}}if(V===`+`){if(f.noextglob!==!0&&U()===`(`&&U(2)!==`?`){Q(`plus`,V);continue}if(B&&B.value===`(`||f.regex===!1){Z({type:`plus`,value:V,output:x});continue}if(B&&(B.type===`bracket`||B.type===`paren`||B.type===`brace`)||I.parens>0){Z({type:`plus`,value:V});continue}Z({type:`plus`,value:x});continue}if(V===`@`){if(f.noextglob!==!0&&U()===`(`&&U(2)!==`?`){Z({type:`at`,extglob:!0,value:V,output:``});continue}Z({type:`text`,value:V});continue}if(V!==`*`){(V===`$`||V===`^`)&&(V=`\\${V}`);let e=REGEX_NON_SPECIAL_CHARS.exec(G());e&&(V+=e[0],I.index+=e[0].length),Z({type:`text`,value:V});continue}if(B&&(B.type===`globstar`||B.star===!0)){B.type=`star`,B.star=!0,B.value+=V,B.output=F,I.backtrack=!0,I.globstar=!0,K(V);continue}let e=G();if(f.noextglob!==!0&&/^\([^?]/.test(e)){Q(`star`,V);continue}if(B.type===`star`){if(f.noglobstar===!0){K(V);continue}let t=B.prev,n=t.prev,r=t.type===`slash`||t.type===`bos`,i=n&&(n.type===`star`||n.type===`globstar`);if(f.bash===!0&&(!r||e[0]&&e[0]!==`/`)){Z({type:`star`,value:V,output:``});continue}let a=I.braces>0&&(t.type===`comma`||t.type===`brace`),o=L.length&&(t.type===`pipe`||t.type===`paren`);if(!r&&t.type!==`paren`&&!a&&!o){Z({type:`star`,value:V,output:``});continue}for(;e.slice(0,3)===`/**`;){let t=u[I.index+4];if(t&&t!==`/`)break;e=e.slice(3),K(`/**`,3)}if(t.type===`bos`&&H()){B.type=`globstar`,B.value+=V,B.output=M(f),I.output=B.output,I.globstar=!0,K(V);continue}if(t.type===`slash`&&t.prev.type!==`bos`&&!i&&H()){I.output=I.output.slice(0,-(t.output+B.output).length),t.output=`(?:${t.output}`,B.type=`globstar`,B.output=M(f)+(f.strictSlashes?`)`:`|$)`),B.value+=V,I.globstar=!0,I.output+=t.output+B.output,K(V);continue}if(t.type===`slash`&&t.prev.type!==`bos`&&e[0]===`/`){let n=e[1]===void 0?``:`|$`;I.output=I.output.slice(0,-(t.output+B.output).length),t.output=`(?:${t.output}`,B.type=`globstar`,B.output=`${M(f)}${S}|${S}${n})`,B.value+=V,I.output+=t.output+B.output,I.globstar=!0,K(V+W()),Z({type:`slash`,value:`/`,output:``});continue}if(t.type===`bos`&&e[0]===`/`){B.type=`globstar`,B.value+=V,B.output=`(?:^|${S}|${M(f)}${S})`,I.output=B.output,I.globstar=!0,K(V+W()),Z({type:`slash`,value:`/`,output:``});continue}I.output=I.output.slice(0,-B.output.length),B.type=`globstar`,B.output=M(f),B.value+=V,I.output+=B.output,I.globstar=!0,K(V);continue}let n={type:`star`,value:V,output:F};if(f.bash===!0){n.output=`.*?`,(B.type===`bos`||B.type===`slash`)&&(n.output=N+n.output),Z(n);continue}if(B&&(B.type===`bracket`||B.type===`paren`)&&f.regex===!0){n.output=V,Z(n);continue}(I.index===I.start||B.type===`slash`||B.type===`dot`)&&(B.type===`dot`?(I.output+=E,B.output+=E):f.dot===!0?(I.output+=D,B.output+=D):(I.output+=N,B.output+=N),U()!==`*`&&(I.output+=C,B.output+=C)),Z(n)}for(;I.brackets>0;){if(f.strictBrackets===!0)throw SyntaxError(syntaxError(`closing`,`]`));I.output=utils.escapeLast(I.output,`[`),X(`brackets`)}for(;I.parens>0;){if(f.strictBrackets===!0)throw SyntaxError(syntaxError(`closing`,`)`));I.output=utils.escapeLast(I.output,`(`),X(`parens`)}for(;I.braces>0;){if(f.strictBrackets===!0)throw SyntaxError(syntaxError(`closing`,`}`));I.output=utils.escapeLast(I.output,`{`),X(`braces`)}if(f.strictSlashes!==!0&&(B.type===`star`||B.type===`bracket`)&&Z({type:`maybe_slash`,value:``,output:`${S}?`}),I.backtrack===!0){I.output=``;for(let e of I.tokens)I.output+=e.output==null?e.value:e.output,e.suffix&&(I.output+=e.suffix)}return I};parse.fastpaths=(r,i)=>{let a={...i},s=typeof a.maxLength==`number`?Math.min(MAX_LENGTH,a.maxLength):MAX_LENGTH,c=r.length;if(c>s)throw SyntaxError(`Input length: ${c}, exceeds maximum allowed length: ${s}`);r=REPLACEMENTS[r]||r;let{DOT_LITERAL:l,SLASH_LITERAL:u,ONE_CHAR:d,DOTS_SLASH:f,NO_DOT:p,NO_DOTS:m,NO_DOTS_SLASH:h,STAR:g,START_ANCHOR:_}=constants.globChars(a.windows),v=a.dot?m:p,y=a.dot?h:p,b=a.capture?``:`?:`,x={negated:!1,prefix:``},S=a.bash===!0?`.*?`:g;a.capture&&(S=`(${S})`);let C=e=>e.noglobstar===!0?S:`(${b}(?:(?!${_}${e.dot?f:l}).)*?)`,w=e=>{switch(e){case`*`:return`${v}${d}${S}`;case`.*`:return`${l}${d}${S}`;case`*.*`:return`${v}${S}${l}${d}${S}`;case`*/*`:return`${v}${S}${u}${d}${y}${S}`;case`**`:return v+C(a);case`**/*`:return`(?:${v}${C(a)}${u})?${y}${d}${S}`;case`**/*.*`:return`(?:${v}${C(a)}${u})?${y}${S}${l}${d}${S}`;case`**/.*`:return`(?:${v}${C(a)}${u})?${l}${d}${S}`;default:{let t=/^(.*?)\.(\w+)$/.exec(e);if(!t)return;let n=w(t[1]);return n?n+l+t[2]:void 0}}},T=w(utils.removePrefix(r,x));return T&&a.strictSlashes!==!0&&(T+=`${u}?`),T},module.exports=parse;