"use strict";Object.defineProperty(exports,`__esModule`,{value:!0}),exports.AST=void 0;const brace_expressions_js_1=require(`./brace-expressions.js`),unescape_js_1=require(`./unescape.js`),types=new Set([`!`,`?`,`+`,`*`,`@`]),isExtglobType=e=>types.has(e),startNoTraversal=`(?!(?:^|/)\\.\\.?(?:$|/))`,startNoDot=`(?!\\.)`,addPatternStart=new Set([`[`,`.`]),justDots=new Set([`..`,`.`]),reSpecials=new Set(`().*{}+?[]^$\\!`),regExpEscape=e=>e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,`\\$&`),qmark=`[^/]`,star=qmark+`*?`,starNoEmpty=qmark+`+?`;class AST{type;#root;#hasMagic;#uflag=!1;#parts=[];#parent;#parentIndex;#negs;#filledNegs=!1;#options;#toString;#emptyExt=!1;constructor(e,t,n={}){this.type=e,e&&(this.#hasMagic=!0),this.#parent=t,this.#root=this.#parent?this.#parent.#root:this,this.#options=this.#root===this?n:this.#root.#options,this.#negs=this.#root===this?[]:this.#root.#negs,e===`!`&&!this.#root.#filledNegs&&this.#negs.push(this),this.#parentIndex=this.#parent?this.#parent.#parts.length:0}get hasMagic(){if(this.#hasMagic!==void 0)return this.#hasMagic;for(let e of this.#parts)if(typeof e!=`string`&&(e.type||e.hasMagic))return this.#hasMagic=!0;return this.#hasMagic}toString(){return this.#toString===void 0?this.type?this.#toString=this.type+`(`+this.#parts.map(e=>String(e)).join(`|`)+`)`:this.#toString=this.#parts.map(e=>String(e)).join(``):this.#toString}#fillNegs(){if(this!==this.#root)throw Error(`should only call on root`);if(this.#filledNegs)return this;this.toString(),this.#filledNegs=!0;let e;for(;e=this.#negs.pop();){if(e.type!==`!`)continue;let t=e,n=t.#parent;for(;n;){for(let r=t.#parentIndex+1;!n.type&&r<n.#parts.length;r++)for(let t of e.#parts){if(typeof t==`string`)throw Error(`string part in extglob AST??`);t.copyIn(n.#parts[r])}t=n,n=t.#parent}}return this}push(...e){for(let t of e)if(t!==``){if(typeof t!=`string`&&!(t instanceof AST&&t.#parent===this))throw Error(`invalid part: `+t);this.#parts.push(t)}}toJSON(){let e=this.type===null?this.#parts.slice().map(e=>typeof e==`string`?e:e.toJSON()):[this.type,...this.#parts.map(e=>e.toJSON())];return this.isStart()&&!this.type&&e.unshift([]),this.isEnd()&&(this===this.#root||this.#root.#filledNegs&&this.#parent?.type===`!`)&&e.push({}),e}isStart(){if(this.#root===this)return!0;if(!this.#parent?.isStart())return!1;if(this.#parentIndex===0)return!0;let e=this.#parent;for(let t=0;t<this.#parentIndex;t++){let n=e.#parts[t];if(!(n instanceof AST&&n.type===`!`))return!1}return!0}isEnd(){if(this.#root===this||this.#parent?.type===`!`)return!0;if(!this.#parent?.isEnd())return!1;if(!this.type)return this.#parent?.isEnd();let e=this.#parent?this.#parent.#parts.length:0;return this.#parentIndex===e-1}copyIn(e){typeof e==`string`?this.push(e):this.push(e.clone(this))}clone(e){let t=new AST(this.type,e);for(let e of this.#parts)t.copyIn(e);return t}static#parseAST(e,t,n,i){let a=!1,o=!1,s=-1,c=!1;if(t.type===null){let l=n,u=``;for(;l<e.length;){let n=e.charAt(l++);if(a||n===`\\`){a=!a,u+=n;continue}if(o){l===s+1?(n===`^`||n===`!`)&&(c=!0):n===`]`&&!(l===s+2&&c)&&(o=!1),u+=n;continue}else if(n===`[`){o=!0,s=l,c=!1,u+=n;continue}if(!i.noext&&isExtglobType(n)&&e.charAt(l)===`(`){t.push(u),u=``;let r=new AST(n,t);l=AST.#parseAST(e,r,l,i),t.push(r);continue}u+=n}return t.push(u),l}let l=n+1,u=new AST(null,t),d=[],f=``;for(;l<e.length;){let n=e.charAt(l++);if(a||n===`\\`){a=!a,f+=n;continue}if(o){l===s+1?(n===`^`||n===`!`)&&(c=!0):n===`]`&&!(l===s+2&&c)&&(o=!1),f+=n;continue}else if(n===`[`){o=!0,s=l,c=!1,f+=n;continue}if(isExtglobType(n)&&e.charAt(l)===`(`){u.push(f),f=``;let t=new AST(n,u);u.push(t),l=AST.#parseAST(e,t,l,i);continue}if(n===`|`){u.push(f),f=``,d.push(u),u=new AST(null,t);continue}if(n===`)`)return f===``&&t.#parts.length===0&&(t.#emptyExt=!0),u.push(f),f=``,t.push(...d,u),l;f+=n}return t.type=null,t.#hasMagic=void 0,t.#parts=[e.substring(n-1)],l}static fromGlob(e,t={}){let n=new AST(null,void 0,t);return AST.#parseAST(e,n,0,t),n}toMMPattern(){if(this!==this.#root)return this.#root.toMMPattern();let e=this.toString(),[t,n,r,i]=this.toRegExpSource();if(!(r||this.#hasMagic||this.#options.nocase&&!this.#options.nocaseMagicOnly&&e.toUpperCase()!==e.toLowerCase()))return n;let a=(this.#options.nocase?`i`:``)+(i?`u`:``);return Object.assign(RegExp(`^${t}$`,a),{_src:t,_glob:e})}get options(){return this.#options}toRegExpSource(e){let n=e??!!this.#options.dot;if(this.#root===this&&this.#fillNegs(),!this.type){let r=this.isStart()&&this.isEnd()&&!this.#parts.some(e=>typeof e!=`string`),i=this.#parts.map(t=>{let[n,i,a,o]=typeof t==`string`?AST.#parseGlob(t,this.#hasMagic,r):t.toRegExpSource(e);return this.#hasMagic=this.#hasMagic||a,this.#uflag=this.#uflag||o,n}).join(``),c=``;if(this.isStart()&&typeof this.#parts[0]==`string`&&!(this.#parts.length===1&&justDots.has(this.#parts[0]))){let t=addPatternStart,r=n&&t.has(i.charAt(0))||i.startsWith(`\\.`)&&t.has(i.charAt(2))||i.startsWith(`\\.\\.`)&&t.has(i.charAt(4)),s=!n&&!e&&t.has(i.charAt(0));c=r?`(?!(?:^|/)\\.\\.?(?:$|/))`:s?startNoDot:``}let l=``;return this.isEnd()&&this.#root.#filledNegs&&this.#parent?.type===`!`&&(l=`(?:$|\\/)`),[c+i+l,(0,unescape_js_1.unescape)(i),this.#hasMagic=!!this.#hasMagic,this.#uflag]}let r=this.type===`*`||this.type===`+`,i=this.type===`!`?`(?:(?!(?:`:`(?:`,c=this.#partsToRegExp(n);if(this.isStart()&&this.isEnd()&&!c&&this.type!==`!`){let e=this.toString();return this.#parts=[e],this.type=null,this.#hasMagic=void 0,[e,(0,unescape_js_1.unescape)(this.toString()),!1,!1]}let l=!r||e||n?``:this.#partsToRegExp(!0);l===c&&(l=``),l&&(c=`(?:${c})(?:${l})*?`);let u=``;if(this.type===`!`&&this.#emptyExt)u=(this.isStart()&&!n?startNoDot:``)+starNoEmpty;else{let t=this.type===`!`?`))`+(this.isStart()&&!n&&!e?startNoDot:``)+star+`)`:this.type===`@`?`)`:this.type===`?`?`)?`:this.type===`+`&&l?`)`:this.type===`*`&&l?`)?`:`)${this.type}`;u=i+c+t}return[u,(0,unescape_js_1.unescape)(c),this.#hasMagic=!!this.#hasMagic,this.#uflag]}#partsToRegExp(e){return this.#parts.map(t=>{if(typeof t==`string`)throw Error(`string type in extglob ast??`);let[n,r,i,a]=t.toRegExpSource(e);return this.#uflag=this.#uflag||a,n}).filter(e=>!(this.isStart()&&this.isEnd())||!!e).join(`|`)}static#parseGlob(n,r,i=!1){let a=!1,o=``,s=!1;for(let t=0;t<n.length;t++){let p=n.charAt(t);if(a){a=!1,o+=(reSpecials.has(p)?`\\`:``)+p;continue}if(p===`\\`){t===n.length-1?o+=`\\\\`:a=!0;continue}if(p===`[`){let[i,a,c,l]=(0,brace_expressions_js_1.parseClass)(n,t);if(c){o+=i,s||=a,t+=c-1,r||=l;continue}}if(p===`*`){o+=i&&n===`*`?starNoEmpty:star,r=!0;continue}if(p===`?`){o+=qmark,r=!0;continue}o+=regExpEscape(p)}return[o,(0,unescape_js_1.unescape)(n),!!r,s]}}exports.AST=AST;