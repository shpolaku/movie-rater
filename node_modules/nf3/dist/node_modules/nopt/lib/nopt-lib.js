const abbrev=require(`abbrev`),debug=require(`./debug`),defaultTypeDefs=require(`./type-defs`),hasOwn=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),getType=(e,{types:t,dynamicTypes:n})=>{let i=hasOwn(t,e),a=t[e];if(!i&&typeof n==`function`){let t=n(e);t!==void 0&&(a=t,i=!0)}return[i,a]},isTypeDef=(e,t)=>t&&e===t,hasTypeDef=(e,t)=>t&&e.indexOf(t)!==-1,doesNotHaveTypeDef=(e,t)=>t&&!hasTypeDef(e,t);function nopt(e,{types:n,shorthands:r,typeDefs:i,invalidHandler:a,unknownHandler:o,abbrevHandler:s,typeDefault:c,dynamicTypes:u}={}){debug(n,r,e,i);let f={},p={remain:[],cooked:e,original:e.slice(0)};return parse(e,f,p.remain,{typeDefs:i,types:n,dynamicTypes:u,shorthands:r,unknownHandler:o,abbrevHandler:s}),clean(f,{types:n,dynamicTypes:u,typeDefs:i,invalidHandler:a,typeDefault:c}),f.argv=p,Object.defineProperty(f.argv,`toString`,{value:function(){return this.original.map(JSON.stringify).join(` `)},enumerable:!1}),f}function clean(e,{types:n={},typeDefs:r={},dynamicTypes:c,invalidHandler:l,typeDefault:d}={}){let f=r.String?.type,p=r.Number?.type,m=r.Array?.type,h=r.Boolean?.type,g=r.Date?.type,_=d!==void 0;_||(d=[!1,!0,null],f&&d.push(f),m&&d.push(m));let v={};Object.keys(e).forEach(f=>{if(f===`argv`)return;let y=e[f];debug(`val=%j`,y);let b=Array.isArray(y),[x,S]=getType(f,{types:n,dynamicTypes:c}),C=S;b||(y=[y]),C||=d,isTypeDef(C,m)&&(C=d.concat(m)),Array.isArray(C)||(C=[C]),debug(`val=%j`,y),debug(`types=`,C),y=y.map(n=>{if(typeof n==`string`&&(debug(`string %j`,n),n=n.trim(),n===`null`&&~C.indexOf(null)||n===`true`&&(~C.indexOf(!0)||hasTypeDef(C,h))||n===`false`&&(~C.indexOf(!1)||hasTypeDef(C,h))?(n=JSON.parse(n),debug(`jsonable %j`,n)):hasTypeDef(C,p)&&!isNaN(n)?(debug(`convert to number`,n),n=+n):hasTypeDef(C,g)&&!isNaN(Date.parse(n))&&(debug(`convert to date`,n),n=new Date(n))),!x){if(!_)return n;S=d}n===!1&&~C.indexOf(null)&&!(~C.indexOf(!1)||hasTypeDef(C,h))&&(n=null);let i={};return i[f]=n,debug(`prevalidated val`,i,n,S),validate(i,f,n,S,{typeDefs:r})?(debug(`validated v`,i,n,S),i[f]):(l?l(f,n,S,e):l!==!1&&debug(`invalid: `+f+`=`+n,S),v)}).filter(e=>e!==v),!y.length&&doesNotHaveTypeDef(C,m)?(debug(`VAL HAS NO LENGTH, DELETE IT`,y,f,C.indexOf(m)),delete e[f]):b?(debug(b,e[f],y),e[f]=y):e[f]=y[0],debug(`k=%s val=%j`,f,y,e[f])})}function validate(e,n,r,i,{typeDefs:o}={}){let s=o?.Array?.type;if(Array.isArray(i)){for(let t=0,c=i.length;t<c;t++)if(!isTypeDef(i[t],s)&&validate(e,n,r,i[t],{typeDefs:o}))return!0;return delete e[n],!1}if(isTypeDef(i,s))return!0;if(i!==i)return debug(`Poison NaN`,n,r,i),delete e[n],!1;if(r===i)return debug(`Explicitly allowed %j`,r),e[n]=r,!0;let c=!1,l=Object.keys(o);for(let a=0,s=l.length;a<s;a++){debug(`test type %j %j %j`,n,r,l[a]);let s=o[l[a]];if(s&&(i&&i.name&&s.type&&s.type.name?i.name===s.type.name:i===s.type)){let t={};if(c=s.validate(t,n,r)!==!1,r=t[n],c){e[n]=r;break}}}return debug(`OK? %j (%j %j %j)`,c,n,r,l[l.length-1]),c||delete e[n],c}function parse(n,s,c,{types:l={},typeDefs:u={},shorthands:d={},dynamicTypes:f,unknownHandler:p,abbrevHandler:h}={}){let g=u.String?.type,_=u.Number?.type,v=u.Array?.type,y=u.Boolean?.type;debug(`parse`,n,s,c);let b=abbrev(Object.keys(l));debug(`abbrevs=%j`,b);let x=abbrev(Object.keys(d));for(let e=0;e<n.length;e++){let u=n[e];if(debug(`arg`,u),u.match(/^-{2,}$/)){c.push.apply(c,n.slice(e+1)),n[e]=`--`;break}let S=!1;if(u.charAt(0)===`-`&&u.length>1){let c=u.indexOf(`=`);if(c>-1){S=!0;let t=u.slice(c+1);u=u.slice(0,c),n.splice(e,1,u,t)}let C=resolveShort(u,x,b,{shorthands:d,abbrevHandler:h});if(debug(`arg=%j shRes=%j`,u,C),C&&(n.splice.apply(n,[e,1].concat(C)),u!==C[0])){e--;continue}u=u.replace(/^-+/,``);let w=null;for(;u.toLowerCase().indexOf(`no-`)===0;)w=!w,u=u.slice(3);b[u]&&b[u]!==u&&(h?h(u,b[u]):h!==!1&&debug(`abbrev: ${u} -> ${b[u]}`),u=b[u]);let[T,E]=getType(u,{types:l,dynamicTypes:f}),D=Array.isArray(E);D&&E.length===1&&(D=!1,E=E[0]);let O=isTypeDef(E,v)||D&&hasTypeDef(E,v);!T&&hasOwn(s,u)&&(Array.isArray(s[u])||(s[u]=[s[u]]),O=!0);let k,A=n[e+1],j=typeof w==`boolean`||isTypeDef(E,y)||D&&hasTypeDef(E,y)||E===void 0&&!S||A===`false`&&(E===null||D&&~E.indexOf(null));if(E===void 0){let e=!S&&A&&!A?.startsWith(`-`)&&![`true`,`false`].includes(A);p?e?p(u,A):p(u):p!==!1&&(debug(`unknown: ${u}`),e&&debug(`unknown: ${A} parsed as normal opt`))}if(j){k=!w,(A===`true`||A===`false`)&&(k=JSON.parse(A),A=null,w&&(k=!k),e++),D&&A&&(~E.indexOf(A)?(k=A,e++):A===`null`&&~E.indexOf(null)?(k=null,e++):!A.match(/^-{2,}[^-]/)&&!isNaN(A)&&hasTypeDef(E,_)?(k=+A,e++):!A.match(/^-[^-]/)&&hasTypeDef(E,g)&&(k=A,e++)),O?(s[u]=s[u]||[]).push(k):s[u]=k;continue}isTypeDef(E,g)&&(A===void 0?A=``:A.match(/^-{1,2}[^-]+/)&&(A=``,e--)),A&&A.match(/^-{2,}$/)&&(A=void 0,e--),k=A===void 0?!0:A,O?(s[u]=s[u]||[]).push(k):s[u]=k,e++;continue}c.push(u)}}const SINGLES=Symbol(`singles`),singleCharacters=(e,n)=>{let r=n[SINGLES];r||(r=Object.keys(n).filter(e=>e.length===1).reduce((e,t)=>(e[t]=!0,e),{}),n[SINGLES]=r,debug(`shorthand singles`,r));let i=e.split(``).filter(e=>r[e]);return i.join(``)===e?i:null};function resolveShort(n,...r){let{abbrevHandler:i,types:a={},shorthands:o={}}=r.length?r.pop():{},s=r[0]??abbrev(Object.keys(o)),c=r[1]??abbrev(Object.keys(a));if(n=n.replace(/^-+/,``),c[n]===n)return null;if(o[n])return o[n]&&!Array.isArray(o[n])&&(o[n]=o[n].split(/\s+/)),o[n];let l=singleCharacters(n,o);return l?l.map(e=>o[e]).reduce((e,t)=>e.concat(t),[]):c[n]&&!o[n]?null:(s[n]&&(i?i(n,s[n]):i!==!1&&debug(`abbrev: ${n} -> ${s[n]}`),n=s[n]),o[n]&&!Array.isArray(o[n])&&(o[n]=o[n].split(/\s+/)),o[n])}module.exports={nopt,clean,parse,validate,resolveShort,typeDefs:defaultTypeDefs};