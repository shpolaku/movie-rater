"use strict";Object.defineProperty(exports,`__esModule`,{value:!0}),exports.Processor=exports.SubWalks=exports.MatchRecord=exports.HasWalkedCache=void 0;const minimatch_1=require(`minimatch`);class HasWalkedCache{store;constructor(e=new Map){this.store=e}copy(){return new HasWalkedCache(new Map(this.store))}hasWalked(e,t){return this.store.get(e.fullpath())?.has(t.globString())}storeWalked(e,t){let n=e.fullpath(),r=this.store.get(n);r?r.add(t.globString()):this.store.set(n,new Set([t.globString()]))}}exports.HasWalkedCache=HasWalkedCache;class MatchRecord{store=new Map;add(e,t,n){let r=(t?2:0)|(n?1:0),i=this.store.get(e);this.store.set(e,i===void 0?r:r&i)}entries(){return[...this.store.entries()].map(([e,t])=>[e,!!(t&2),!!(t&1)])}}exports.MatchRecord=MatchRecord;class SubWalks{store=new Map;add(e,t){if(!e.canReaddir())return;let n=this.store.get(e);n?n.find(e=>e.globString()===t.globString())||n.push(t):this.store.set(e,[t])}get(e){let t=this.store.get(e);if(!t)throw Error(`attempting to walk unknown path`);return t}entries(){return this.keys().map(e=>[e,this.store.get(e)])}keys(){return[...this.store.keys()].filter(e=>e.canReaddir())}}exports.SubWalks=SubWalks;class Processor{hasWalkedCache;matches=new MatchRecord;subwalks=new SubWalks;patterns;follow;dot;opts;constructor(e,n){this.opts=e,this.follow=!!e.follow,this.dot=!!e.dot,this.hasWalkedCache=n?n.copy():new HasWalkedCache}processPatterns(t,n){this.patterns=n;let r=n.map(e=>[t,e]);for(let[t,n]of r){this.hasWalkedCache.storeWalked(t,n);let r=n.root(),i=n.isAbsolute()&&this.opts.absolute!==!1;if(r){t=t.resolve(r===`/`&&this.opts.root!==void 0?this.opts.root:r);let e=n.rest();if(e)n=e;else{this.matches.add(t,!0,!1);continue}}if(t.isENOENT())continue;let a,o,s=!1;for(;typeof(a=n.pattern())==`string`&&(o=n.rest());)t=t.resolve(a),n=o,s=!0;if(a=n.pattern(),o=n.rest(),s){if(this.hasWalkedCache.hasWalked(t,n))continue;this.hasWalkedCache.storeWalked(t,n)}if(typeof a==`string`){let e=a===`..`||a===``||a===`.`;this.matches.add(t.resolve(a),i,e);continue}else if(a===minimatch_1.GLOBSTAR){(!t.isSymbolicLink()||this.follow||n.checkFollowGlobstar())&&this.subwalks.add(t,n);let e=o?.pattern(),r=o?.rest();if(!o||(e===``||e===`.`)&&!r)this.matches.add(t,i,e===``||e===`.`);else if(e===`..`){let e=t.parent||t;r?this.hasWalkedCache.hasWalked(e,r)||this.subwalks.add(e,r):this.matches.add(e,i,!0)}}else a instanceof RegExp&&this.subwalks.add(t,n)}return this}subwalkTargets(){return this.subwalks.keys()}child(){return new Processor(this.opts,this.hasWalkedCache)}filterEntries(t,n){let r=this.subwalks.get(t),i=this.child();for(let t of n)for(let n of r){let r=n.isAbsolute(),a=n.pattern(),o=n.rest();a===minimatch_1.GLOBSTAR?i.testGlobstar(t,n,o,r):a instanceof RegExp?i.testRegExp(t,a,o,r):i.testString(t,a,o,r)}return i}testGlobstar(e,t,n,r){if((this.dot||!e.name.startsWith(`.`))&&(t.hasMore()||this.matches.add(e,r,!1),e.canReaddir()&&(this.follow||!e.isSymbolicLink()?this.subwalks.add(e,t):e.isSymbolicLink()&&(n&&t.checkFollowGlobstar()?this.subwalks.add(e,n):t.markFollowGlobstar()&&this.subwalks.add(e,t)))),n){let t=n.pattern();if(typeof t==`string`&&t!==`..`&&t!==``&&t!==`.`)this.testString(e,t,n.rest(),r);else if(t===`..`){let t=e.parent||e;this.subwalks.add(t,n)}else t instanceof RegExp&&this.testRegExp(e,t,n.rest(),r)}}testRegExp(e,t,n,r){t.test(e.name)&&(n?this.subwalks.add(e,n):this.matches.add(e,r,!1))}testString(e,t,n,r){e.isNamed(t)&&(n?this.subwalks.add(e,n):this.matches.add(e,r,!1))}}exports.Processor=Processor;