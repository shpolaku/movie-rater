var fs=require(`fs`),polyfills=require(`./polyfills.js`),legacy=require(`./legacy-streams.js`),clone=require(`./clone.js`),util=require(`util`),gracefulQueue,previousSymbol;typeof Symbol==`function`&&typeof Symbol.for==`function`?(gracefulQueue=Symbol.for(`graceful-fs.queue`),previousSymbol=Symbol.for(`graceful-fs.previous`)):(gracefulQueue=`___graceful-fs.queue`,previousSymbol=`___graceful-fs.previous`);function noop(){}function publishQueue(e,t){Object.defineProperty(e,gracefulQueue,{get:function(){return t}})}var debug=noop;util.debuglog?debug=util.debuglog(`gfs4`):/\bgfs4\b/i.test(process.env.NODE_DEBUG||``)&&(debug=function(){var e=util.format.apply(util,arguments);e=`GFS4: `+e.split(/\n/).join(`
GFS4: `),console.error(e)}),fs[gracefulQueue]||(publishQueue(fs,global[gracefulQueue]||[]),fs.close=(function(t){function n(n,r){return t.call(fs,n,function(e){e||resetQueue(),typeof r==`function`&&r.apply(this,arguments)})}return Object.defineProperty(n,previousSymbol,{value:t}),n})(fs.close),fs.closeSync=(function(t){function n(n){t.apply(fs,arguments),resetQueue()}return Object.defineProperty(n,previousSymbol,{value:t}),n})(fs.closeSync),/\bgfs4\b/i.test(process.env.NODE_DEBUG||``)&&process.on(`exit`,function(){debug(fs[gracefulQueue]),require(`assert`).equal(fs[gracefulQueue].length,0)})),global[gracefulQueue]||publishQueue(global,fs[gracefulQueue]),module.exports=patch(clone(fs)),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&!fs.__patched&&(module.exports=patch(fs),fs.__patched=!0);function patch(e){polyfills(e),e.gracefulify=patch,e.createReadStream=T,e.createWriteStream=E;var r=e.readFile;e.readFile=i;function i(e,t,n){return typeof t==`function`&&(n=t,t=null),i(e,t,n);function i(e,t,n,a){return r(e,t,function(r){r&&(r.code===`EMFILE`||r.code===`ENFILE`)?enqueue([i,[e,t,n],r,a||Date.now(),Date.now()]):typeof n==`function`&&n.apply(this,arguments)})}}var a=e.writeFile;e.writeFile=o;function o(e,t,n,r){return typeof n==`function`&&(r=n,n=null),i(e,t,n,r);function i(e,t,n,r,o){return a(e,t,n,function(a){a&&(a.code===`EMFILE`||a.code===`ENFILE`)?enqueue([i,[e,t,n,r],a,o||Date.now(),Date.now()]):typeof r==`function`&&r.apply(this,arguments)})}}var s=e.appendFile;s&&(e.appendFile=c);function c(e,t,n,r){return typeof n==`function`&&(r=n,n=null),i(e,t,n,r);function i(e,t,n,r,a){return s(e,t,n,function(o){o&&(o.code===`EMFILE`||o.code===`ENFILE`)?enqueue([i,[e,t,n,r],o,a||Date.now(),Date.now()]):typeof r==`function`&&r.apply(this,arguments)})}}var l=e.copyFile;l&&(e.copyFile=f);function f(e,t,n,r){return typeof n==`function`&&(r=n,n=0),i(e,t,n,r);function i(e,t,n,r,a){return l(e,t,n,function(o){o&&(o.code===`EMFILE`||o.code===`ENFILE`)?enqueue([i,[e,t,n,r],o,a||Date.now(),Date.now()]):typeof r==`function`&&r.apply(this,arguments)})}}var p=e.readdir;e.readdir=h;var m=/^v[0-5]\./;function h(e,t,n){typeof t==`function`&&(n=t,t=null);var r=m.test(process.version)?function(e,t,n,r){return p(e,i(e,t,n,r))}:function(e,t,n,r){return p(e,t,i(e,t,n,r))};return r(e,t,n);function i(e,t,n,i){return function(a,o){a&&(a.code===`EMFILE`||a.code===`ENFILE`)?enqueue([r,[e,t,n],a,i||Date.now(),Date.now()]):(o&&o.sort&&o.sort(),typeof n==`function`&&n.call(this,a,o))}}}if(process.version.substr(0,4)===`v0.8`){var g=legacy(e);x=g.ReadStream,C=g.WriteStream}var _=e.ReadStream;_&&(x.prototype=Object.create(_.prototype),x.prototype.open=S);var v=e.WriteStream;v&&(C.prototype=Object.create(v.prototype),C.prototype.open=w),Object.defineProperty(e,`ReadStream`,{get:function(){return x},set:function(e){x=e},enumerable:!0,configurable:!0}),Object.defineProperty(e,`WriteStream`,{get:function(){return C},set:function(e){C=e},enumerable:!0,configurable:!0});var y=x;Object.defineProperty(e,`FileReadStream`,{get:function(){return y},set:function(e){y=e},enumerable:!0,configurable:!0});var b=C;Object.defineProperty(e,`FileWriteStream`,{get:function(){return b},set:function(e){b=e},enumerable:!0,configurable:!0});function x(e,t){return this instanceof x?(_.apply(this,arguments),this):x.apply(Object.create(x.prototype),arguments)}function S(){var e=this;O(e.path,e.flags,e.mode,function(t,n){t?(e.autoClose&&e.destroy(),e.emit(`error`,t)):(e.fd=n,e.emit(`open`,n),e.read())})}function C(e,t){return this instanceof C?(v.apply(this,arguments),this):C.apply(Object.create(C.prototype),arguments)}function w(){var e=this;O(e.path,e.flags,e.mode,function(t,n){t?(e.destroy(),e.emit(`error`,t)):(e.fd=n,e.emit(`open`,n))})}function T(t,n){return new e.ReadStream(t,n)}function E(t,n){return new e.WriteStream(t,n)}var D=e.open;e.open=O;function O(e,t,n,r){return typeof n==`function`&&(r=n,n=null),i(e,t,n,r);function i(e,t,n,r,a){return D(e,t,n,function(o,s){o&&(o.code===`EMFILE`||o.code===`ENFILE`)?enqueue([i,[e,t,n,r],o,a||Date.now(),Date.now()]):typeof r==`function`&&r.apply(this,arguments)})}}return e}function enqueue(t){debug(`ENQUEUE`,t[0].name,t[1]),fs[gracefulQueue].push(t),retry()}var retryTimer;function resetQueue(){for(var t=Date.now(),n=0;n<fs[gracefulQueue].length;++n)fs[gracefulQueue][n].length>2&&(fs[gracefulQueue][n][3]=t,fs[gracefulQueue][n][4]=t);retry()}function retry(){if(clearTimeout(retryTimer),retryTimer=void 0,fs[gracefulQueue].length!==0){var t=fs[gracefulQueue].shift(),n=t[0],r=t[1],i=t[2],o=t[3],s=t[4];if(o===void 0)debug(`RETRY`,n.name,r),n.apply(null,r);else if(Date.now()-o>=6e4){debug(`TIMEOUT`,n.name,r);var c=r.pop();typeof c==`function`&&c.call(null,i)}else{var u=Date.now()-s,d=Math.max(s-o,1);u>=Math.min(d*1.2,100)?(debug(`RETRY`,n.name,r),n.apply(null,r.concat([o]))):fs[gracefulQueue].push(t)}retryTimer===void 0&&(retryTimer=setTimeout(retry,0))}}