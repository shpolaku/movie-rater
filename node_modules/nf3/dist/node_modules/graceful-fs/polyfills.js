var constants=require(`constants`),origCwd=process.cwd,cwd=null,platform=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return cwd||=origCwd.call(process),cwd};try{process.cwd()}catch{}if(typeof process.chdir==`function`){var chdir=process.chdir;process.chdir=function(e){cwd=null,chdir.call(process,e)},Object.setPrototypeOf&&Object.setPrototypeOf(process.chdir,chdir)}module.exports=patch;function patch(t){constants.hasOwnProperty(`O_SYMLINK`)&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&n(t),t.lutimes||i(t),t.chown=s(t.chown),t.fchown=s(t.fchown),t.lchown=s(t.lchown),t.chmod=a(t.chmod),t.fchmod=a(t.fchmod),t.lchmod=a(t.lchmod),t.chownSync=c(t.chownSync),t.fchownSync=c(t.fchownSync),t.lchownSync=c(t.lchownSync),t.chmodSync=o(t.chmodSync),t.fchmodSync=o(t.fchmodSync),t.lchmodSync=o(t.lchmodSync),t.stat=l(t.stat),t.fstat=l(t.fstat),t.lstat=l(t.lstat),t.statSync=u(t.statSync),t.fstatSync=u(t.fstatSync),t.lstatSync=u(t.lstatSync),t.chmod&&!t.lchmod&&(t.lchmod=function(e,t,n){n&&process.nextTick(n)},t.lchmodSync=function(){}),t.chown&&!t.lchown&&(t.lchown=function(e,t,n,r){r&&process.nextTick(r)},t.lchownSync=function(){}),platform===`win32`&&(t.rename=typeof t.rename==`function`?(function(e){function n(n,r,i){var a=Date.now(),o=0;e(n,r,function s(c){if(c&&(c.code===`EACCES`||c.code===`EPERM`||c.code===`EBUSY`)&&Date.now()-a<6e4){setTimeout(function(){t.stat(r,function(t,a){t&&t.code===`ENOENT`?e(n,r,s):i(c)})},o),o<100&&(o+=10);return}i&&i(c)})}return Object.setPrototypeOf&&Object.setPrototypeOf(n,e),n})(t.rename):t.rename),t.read=typeof t.read==`function`?(function(e){function n(n,r,i,a,o,s){var c;if(s&&typeof s==`function`){var l=0;c=function(u,d,f){if(u&&u.code===`EAGAIN`&&l<10)return l++,e.call(t,n,r,i,a,o,c);s.apply(this,arguments)}}return e.call(t,n,r,i,a,o,c)}return Object.setPrototypeOf&&Object.setPrototypeOf(n,e),n})(t.read):t.read,t.readSync=typeof t.readSync==`function`?(function(e){return function(n,r,i,a,o){for(var s=0;;)try{return e.call(t,n,r,i,a,o)}catch(e){if(e.code===`EAGAIN`&&s<10){s++;continue}throw e}}})(t.readSync):t.readSync;function n(t){t.lchmod=function(n,r,i){t.open(n,constants.O_WRONLY|constants.O_SYMLINK,r,function(e,n){if(e){i&&i(e);return}t.fchmod(n,r,function(e){t.close(n,function(t){i&&i(e||t)})})})},t.lchmodSync=function(n,r){var i=t.openSync(n,constants.O_WRONLY|constants.O_SYMLINK,r),a=!0,o;try{o=t.fchmodSync(i,r),a=!1}finally{if(a)try{t.closeSync(i)}catch{}else t.closeSync(i)}return o}}function i(t){constants.hasOwnProperty(`O_SYMLINK`)&&t.futimes?(t.lutimes=function(n,r,i,a){t.open(n,constants.O_SYMLINK,function(e,n){if(e){a&&a(e);return}t.futimes(n,r,i,function(e){t.close(n,function(t){a&&a(e||t)})})})},t.lutimesSync=function(n,r,i){var a=t.openSync(n,constants.O_SYMLINK),o,s=!0;try{o=t.futimesSync(a,r,i),s=!1}finally{if(s)try{t.closeSync(a)}catch{}else t.closeSync(a)}return o}):t.futimes&&(t.lutimes=function(e,t,n,r){r&&process.nextTick(r)},t.lutimesSync=function(){})}function a(e){return e&&function(n,r,i){return e.call(t,n,r,function(e){d(e)&&(e=null),i&&i.apply(this,arguments)})}}function o(e){return e&&function(n,r){try{return e.call(t,n,r)}catch(e){if(!d(e))throw e}}}function s(e){return e&&function(n,r,i,a){return e.call(t,n,r,i,function(e){d(e)&&(e=null),a&&a.apply(this,arguments)})}}function c(e){return e&&function(n,r,i){try{return e.call(t,n,r,i)}catch(e){if(!d(e))throw e}}}function l(e){return e&&function(n,r,i){typeof r==`function`&&(i=r,r=null);function a(e,t){t&&(t.uid<0&&(t.uid+=4294967296),t.gid<0&&(t.gid+=4294967296)),i&&i.apply(this,arguments)}return r?e.call(t,n,r,a):e.call(t,n,a)}}function u(e){return e&&function(n,r){var i=r?e.call(t,n,r):e.call(t,n);return i&&(i.uid<0&&(i.uid+=4294967296),i.gid<0&&(i.gid+=4294967296)),i}}function d(e){return!e||e.code===`ENOSYS`||(!process.getuid||process.getuid()!==0)&&(e.code===`EINVAL`||e.code===`EPERM`)}}