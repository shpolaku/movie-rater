"use strict";module.exports=exports=testpackage,exports.usage=`Tests that the staged package is valid`;const fs=require(`fs`),path=require(`path`),log=require(`./util/log.js`),existsAsync=fs.exists||path.exists,versioning=require(`./util/versioning.js`),napi=require(`./util/napi.js`),testbinary=require(`./testbinary.js`),tar=require(`tar`);function testpackage(t,a,o){let s=t.package_json,c=napi.get_napi_build_version_from_command_args(a),l=versioning.evaluate(s,t.opts,c),u=l.staged_tarball;existsAsync(u,n=>{if(!n)return o(Error(`Cannot test package because `+u+" missing: run `node-pre-gyp package` first"));let r=l.module_path;function i(e){log.info(`install`,`unpacking [`+e.path+`]`)}fs.promises.mkdir(r,{recursive:!0}).then(()=>{tar.extract({file:u,cwd:r,strip:1,onentry:i}).then(c,o)}).catch(e=>o(e));function c(){testbinary(t,a,e=>e?o(e):(console.log(`[`+s.name+`] Package appears valid`),o()))}})}