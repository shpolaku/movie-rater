"use strict";module.exports=exports=testbinary,exports.usage=`Tests that the binary.node can be required`;const path=require(`path`),log=require(`./util/log.js`),cp=require(`child_process`),versioning=require(`./util/versioning.js`),napi=require(`./util/napi.js`);function testbinary(a,o,s){let c=[],l={},u=process.execPath,d=a.package_json,f=napi.get_napi_build_version_from_command_args(o),p=versioning.evaluate(d,a.opts,f);if(p.runtime&&p.runtime!==`node-webkit`&&p.runtime!==`node`)return s();let m=p.runtime&&p.runtime===`node-webkit`,h=p.module.replace(/\\/g,`/`);if(process.arch!==p.target_arch||process.platform!==p.target_platform){let e=`skipping validation since host platform/arch (`;return e+=process.platform+`/`+process.arch+`)`,e+=` does not match target (`,e+=p.target_platform+`/`+p.target_arch+`)`,log.info(`validate`,e),s()}if(m){l.timeout=5e3,u=process.platform===`darwin`?`node-webkit`:process.platform===`win32`?`nw.exe`:`nw`;let r=path.resolve(h),i=path.join(__dirname,`util`,`nw-pre-gyp`);c.push(i),c.push(r),log.info(`validate`,`Running test command: '`+u+` `+c.join(` `)+`'`),cp.execFile(u,c,l,(e,n,r)=>{if(e){if(e.killed===!0&&e.signal&&e.signal.indexOf(`SIG`)>-1)return s();let n=r.toString();return log.info(`stderr`,n),/^\s*Xlib:\s*extension\s*"RANDR"\s*missing\s*on\s*display\s*":\d+\.\d+"\.\s*$/.test(n)?(log.info(`RANDR`,`stderr contains only RANDR error, ignored`),s()):s(e)}return s()});return}c.push(`--eval`),c.push(`require('`+h.replace(/'/g,`'`)+`')`),log.info(`validate`,`Running test command: '`+u+` `+c.join(` `)+`'`),cp.execFile(u,c,l,(e,t,n)=>e?s(e,{stdout:t,stderr:n}):s())}