"use strict";module.exports=exports=_package,exports.usage=`Packs binary (and enclosing directory) into locally staged tarball`;const fs=require(`fs`),path=require(`path`),log=require(`./util/log.js`),versioning=require(`./util/versioning.js`),napi=require(`./util/napi.js`),existsAsync=fs.exists||path.exists,tar=require(`tar`);function readdirSync(t){let n=[];return fs.readdirSync(t).forEach(r=>{fs.lstatSync(path.join(t,r)).isDirectory()?n=n.concat(readdirSync(path.join(t,r))):n.push(path.join(t,r))}),n}function _package(a,o,s){let c=a.package_json,l=napi.get_napi_build_version_from_command_args(o),u=versioning.evaluate(c,a.opts,l),d=u.module_path,f=path.join(d,u.module_name+`.node`);existsAsync(f,n=>{if(!n)return s(Error(`Cannot package because `+f+" missing: run `node-pre-gyp rebuild` first"));let r=u.staged_tarball,i=function(e){let t=path.basename(e);return t.length&&t[0]!==`.`?(console.log(`packing `+e),!0):(console.log(`skipping `+e),!1)};fs.promises.mkdir(path.dirname(r),{recursive:!0}).then(()=>{let e=readdirSync(d),n=path.basename(d);e=e.map(e=>path.join(n,path.relative(d,e))),tar.create({portable:!1,gzip:!0,filter:i,file:r,cwd:path.dirname(d)},e,e=>(e?console.error(`[`+c.name+`] `+e.message):log.info(`package`,`Binary staged at "`+r+`"`),s(e)))}).catch(e=>s(e))})}