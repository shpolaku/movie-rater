"use strict";module.exports=exports;const fs=require(`fs`),path=require(`path`),nopt=require(`nopt`),log=require(`./util/log.js`),napi=require(`./util/napi.js`),EE=require(`events`).EventEmitter,inherits=require(`util`).inherits,cli_commands=[`clean`,`install`,`reinstall`,`build`,`rebuild`,`package`,`testpackage`,`publish`,`unpublish`,`info`,`testbinary`,`reveal`,`configure`],aliases={};Object.defineProperty(exports,`find`,{get:function(){return require(`./pre-binding`).find},enumerable:!0});function Run({package_json_path:e=`./package.json`,argv:t}){this.package_json_path=e,this.commands={};let n=this;cli_commands.forEach(e=>{n.commands[e]=function(t,i){return log.verbose(`command`,e,t),require(`./`+e)(n,t,i)}}),this.parseArgv(t),this.binaryHostSet=!1}inherits(Run,EE),exports.Run=Run;const proto=Run.prototype;proto.package=require(`../package.json`),proto.configDefs={help:Boolean,arch:String,debug:Boolean,directory:String,proxy:String,loglevel:String,acl:String},proto.shorthands={release:`--no-debug`,C:`--directory`,debug:`--debug`,j:`--jobs`,silent:`--loglevel=silent`,silly:`--loglevel=silly`,verbose:`--loglevel=verbose`},proto.aliases=aliases,proto.parseArgv=function(a){this.opts=nopt(this.configDefs,this.shorthands,a),this.argv=this.opts.argv.remain.slice();let o=this.todo=[];a=this.argv.map(e=>(e in this.aliases&&(e=this.aliases[e]),e)),a.slice().forEach(e=>{if(e in this.commands){let t=a.splice(0,a.indexOf(e));a.shift(),o.length>0&&(o[o.length-1].args=t),o.push({name:e,args:[]})}}),o.length>0&&(o[o.length-1].args=a.splice(0));let s=this.package_json_path;this.opts.directory&&(s=path.join(this.opts.directory,s)),this.package_json=JSON.parse(fs.readFileSync(s)),this.todo=napi.expand_commands(this.package_json,this.opts,o);let c=`npm_config_`;Object.keys(process.env).forEach(e=>{if(e.indexOf(c)!==0)return;let t=process.env[e];e===c+`loglevel`?log.level=t:(e=e.substring(11),e===`argv`&&this.opts.argv&&this.opts.argv.remain&&this.opts.argv.remain.length||(this.opts[e]=t))}),this.opts.loglevel&&(log.level=this.opts.loglevel),log.resume()},proto.setBinaryHostProperty=function(e){if(this.binaryHostSet)return this.package_json.binary.host;let t=this.package_json;if(!t||!t.binary||t.binary.host||!t.binary.staging_host||!t.binary.production_host)return``;let n=`production_host`;(e===`publish`||e===`unpublish`)&&(n=`staging_host`);let r=process.env.node_pre_gyp_s3_host;if(r===`staging`||r===`production`)n=`${r}_host`;else if(this.opts.s3_host===`staging`||this.opts.s3_host===`production`)n=`${this.opts.s3_host}_host`;else if(this.opts.s3_host||r)throw Error(`invalid s3_host ${this.opts.s3_host||r}`);return t.binary.host=t.binary[n],this.binaryHostSet=!0,t.binary.host},proto.usage=function(){return[``,`  Usage: node-pre-gyp <command> [options]`,``,`  where <command> is one of:`,cli_commands.map(e=>`    - `+e+` - `+require(`./`+e).usage).join(`
`),``,`node-pre-gyp@`+this.version+`  `+path.resolve(__dirname,`..`),`node@`+process.versions.node].join(`
`)},Object.defineProperty(proto,`version`,{get:function(){return this.package.version},enumerable:!0});