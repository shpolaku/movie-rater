"use strict";const fs=require(`fs`);module.exports=exports;const versionArray=process.version.substr(1).replace(/-.*$/,``).split(`.`).map(e=>+e),napi_multiple_commands=[`build`,`clean`,`configure`,`package`,`publish`,`reveal`,`testbinary`,`testpackage`,`unpublish`],napi_build_version_tag=`napi_build_version=`;module.exports.get_napi_version=function(){let e=process.versions.napi;return e||(versionArray[0]===9&&versionArray[1]>=3?e=2:versionArray[0]===8&&(e=1)),e},module.exports.get_napi_version_as_string=function(e){let t=module.exports.get_napi_version(e);return t?``+t:``},module.exports.validate_package_json=function(e,t){let n=e.binary,r=pathOK(n.module_path),a=pathOK(n.remote_path),o=pathOK(n.package_name),s=module.exports.get_napi_build_versions(e,t,!0),c=module.exports.get_napi_build_versions_raw(e);if(s&&s.forEach(e=>{if(!(parseInt(e,10)===e&&e>0))throw Error(`All values specified in napi_versions must be positive integers.`)}),s&&(!r||!a&&!o))throw Error("When napi_versions is specified; module_path and either remote_path or package_name must contain the substitution string '{napi_build_version}`.");if((r||a||o)&&!c)throw Error("When the substitution string '{napi_build_version}` is specified in module_path, remote_path, or package_name; napi_versions must also be specified.");if(s&&!module.exports.get_best_napi_build_version(e,t)&&module.exports.build_napi_only(e)||c&&!s&&module.exports.build_napi_only(e))throw Error(`The Node-API version of this Node instance is `+module.exports.get_napi_version(t?t.target:void 0)+`. This module supports Node-API version(s) `+module.exports.get_napi_build_versions_raw(e)+`. This Node instance cannot run this module.`)};function pathOK(e){return e&&(e.indexOf(`{napi_build_version}`)!==-1||e.indexOf(`{node_napi_label}`)!==-1)}module.exports.expand_commands=function(e,t,i){let a=[],o=module.exports.get_napi_build_versions(e,t);return i.forEach(i=>{if(o&&i.name===`install`){let n=module.exports.get_best_napi_build_version(e,t),o=n?[napi_build_version_tag+n]:[];a.push({name:i.name,args:o})}else o&&napi_multiple_commands.indexOf(i.name)!==-1?o.forEach(e=>{let t=i.args.slice();t.push(napi_build_version_tag+e),a.push({name:i.name,args:t})}):a.push(i)}),a},module.exports.get_napi_build_versions=function(e,t,n){let r=require(`./log.js`),i=[],a=module.exports.get_napi_version(t?t.target:void 0);if(e.binary&&e.binary.napi_versions&&e.binary.napi_versions.forEach(e=>{let t=i.indexOf(e)!==-1;!t&&a&&e<=a?i.push(e):n&&!t&&a&&r.info(`This Node instance does not support builds for Node-API version`,e)}),t&&t[`build-latest-napi-version-only`]){let e=0;i.forEach(t=>{t>e&&(e=t)}),i=e?[e]:[]}return i.length?i:void 0},module.exports.get_napi_build_versions_raw=function(e){let t=[];return e.binary&&e.binary.napi_versions&&e.binary.napi_versions.forEach(e=>{t.indexOf(e)===-1&&t.push(e)}),t.length?t:void 0},module.exports.get_command_arg=function(e){return napi_build_version_tag+e},module.exports.get_napi_build_version_from_command_args=function(e){for(let t=0;t<e.length;t++){let n=e[t];if(n.indexOf(napi_build_version_tag)===0)return parseInt(n.substr(19),10)}},module.exports.swap_build_dir_out=function(t){t&&(fs.rmSync(module.exports.get_build_dir(t),{recursive:!0,force:!0}),fs.renameSync(`build`,module.exports.get_build_dir(t)))},module.exports.swap_build_dir_in=function(t){t&&(fs.rmSync(`build`,{recursive:!0,force:!0}),fs.renameSync(module.exports.get_build_dir(t),`build`))},module.exports.get_build_dir=function(e){return`build-tmp-napi-v`+e},module.exports.get_best_napi_build_version=function(e,t){let n=0,r=module.exports.get_napi_build_versions(e,t);if(r){let e=module.exports.get_napi_version(t?t.target:void 0);r.forEach(t=>{t>n&&t<=e&&(n=t)})}return n===0?void 0:n},module.exports.build_napi_only=function(e){return e.binary&&e.binary.package_name&&e.binary.package_name.indexOf(`{node_napi_label}`)===-1};