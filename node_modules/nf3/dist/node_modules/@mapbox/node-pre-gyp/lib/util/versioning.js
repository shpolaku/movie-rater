"use strict";module.exports=exports;const path=require(`path`),semver=require(`semver`),url=require(`url`),detect_libc=require(`detect-libc`),napi=require(`./napi.js`);let abi_crosswalk;abi_crosswalk=process.env.NODE_PRE_GYP_ABI_CROSSWALK?require(process.env.NODE_PRE_GYP_ABI_CROSSWALK):require(`./abi_crosswalk.json`);const major_versions={};Object.keys(abi_crosswalk).forEach(e=>{let t=e.split(`.`)[0];major_versions[t]||(major_versions[t]=e)});function get_electron_abi(e,n){if(!e)throw Error(`get_electron_abi requires valid runtime arg`);if(n===void 0)throw Error(`Empty target version is not supported if electron is the target.`);let r=semver.parse(n);return e+`-v`+r.major+`.`+r.minor}module.exports.get_electron_abi=get_electron_abi;function get_node_webkit_abi(e,t){if(!e)throw Error(`get_node_webkit_abi requires valid runtime arg`);if(t===void 0)throw Error(`Empty target version is not supported if node-webkit is the target.`);return e+`-v`+t}module.exports.get_node_webkit_abi=get_node_webkit_abi;function get_node_abi(e,n){if(!e)throw Error(`get_node_abi requires valid runtime arg`);if(!n)throw Error(`get_node_abi requires valid process.versions object`);let r=semver.parse(n.node);return r.major===0&&r.minor%2?e+`-v`+n.node:n.modules?e+`-v`+ +n.modules:`v8-`+n.v8.split(`.`).slice(0,2).join(`.`)}module.exports.get_node_abi=get_node_abi;function get_runtime_abi(e,t){if(!e)throw Error(`get_runtime_abi requires valid runtime arg`);if(e===`node-webkit`)return get_node_webkit_abi(e,t||process.versions[`node-webkit`]);if(e===`electron`)return get_electron_abi(e,t||process.versions.electron);if(e!==`node`)throw Error(`Unknown Runtime: '`+e+`'`);if(t){let n;if(abi_crosswalk[t])n=abi_crosswalk[t];else{let e=t.split(`.`).map(e=>+e);if(e.length!==3)throw Error(`Unknown target version: `+t);let r=e[0],i=e[1],s=e[2];if(r===1)for(;;){i>0&&--i,s>0&&--s;let e=``+r+`.`+i+`.`+s;if(abi_crosswalk[e]){n=abi_crosswalk[e],console.log(`Warning: node-pre-gyp could not find exact match for `+t),console.log(`Warning: but node-pre-gyp successfully choose `+e+` as ABI compatible target`);break}if(i===0&&s===0)break}else if(r>=2)major_versions[r]&&(n=abi_crosswalk[major_versions[r]],console.log(`Warning: node-pre-gyp could not find exact match for `+t),console.log(`Warning: but node-pre-gyp successfully choose `+major_versions[r]+` as ABI compatible target`));else if(r===0&&e[1]%2==0)for(;--s>0;){let e=``+r+`.`+i+`.`+s;if(abi_crosswalk[e]){n=abi_crosswalk[e],console.log(`Warning: node-pre-gyp could not find exact match for `+t),console.log(`Warning: but node-pre-gyp successfully choose `+e+` as ABI compatible target`);break}}}if(!n)throw Error(`Unsupported target version: `+t);return get_node_abi(e,{node:t,v8:n.v8+`.0`,modules:n.node_abi>1?n.node_abi:void 0})}else return get_node_abi(e,process.versions)}module.exports.get_runtime_abi=get_runtime_abi;const required_parameters=[`module_name`,`module_path`,`host`];function validate_config(e,t){let r=e.name+` package.json is not node-pre-gyp ready:
`,a=[];e.main||a.push(`main`),e.version||a.push(`version`),e.name||a.push(`name`),e.binary||a.push(`binary`);let o=e.binary;if(o&&required_parameters.forEach(e=>{(!o[e]||typeof o[e]!=`string`)&&a.push(`binary.`+e)}),a.length>=1)throw Error(r+`package.json must declare these properties: 
`+a.join(`
`));if(o){let e=url.parse(o.host).protocol;if(e===`http:`)throw Error(`'host' protocol (`+e+`) is invalid - only 'https:' is accepted`)}napi.validate_package_json(e,t)}module.exports.validate_config=validate_config;function eval_template(e,t){return Object.keys(t).forEach(n=>{let r=`{`+n+`}`;for(;e.indexOf(r)>-1;)e=e.replace(r,t[n])}),e}function fix_slashes(e){return e.slice(-1)===`/`?e:e+`/`}function drop_double_slashes(e){return e.replace(/\/\//g,`/`)}function get_process_runtime(e){let t=`node`;return e[`node-webkit`]?t=`node-webkit`:e.electron&&(t=`electron`),t}module.exports.get_process_runtime=get_process_runtime;const default_package_name=`{module_name}-v{version}-{node_abi}-{platform}-{arch}.tar.gz`,default_remote_path=``;module.exports.evaluate=function(a,o,s){o||={},validate_config(a,o);let c=a.version,l=semver.parse(c),u=o.runtime||get_process_runtime(process.versions),d={name:a.name,configuration:o.debug?`Debug`:`Release`,debug:o.debug,module_name:a.binary.module_name,version:l.version,prerelease:l.prerelease.length?l.prerelease.join(`.`):``,build:l.build.length?l.build.join(`.`):``,major:l.major,minor:l.minor,patch:l.patch,runtime:u,node_abi:get_runtime_abi(u,o.target),node_abi_napi:napi.get_napi_version(o.target)?`napi`:get_runtime_abi(u,o.target),napi_version:napi.get_napi_version(o.target),napi_build_version:s||``,node_napi_label:s?`napi-v`+s:get_runtime_abi(u,o.target),target:o.target||``,platform:o.target_platform||process.platform,target_platform:o.target_platform||process.platform,arch:o.target_arch||process.arch,target_arch:o.target_arch||process.arch,libc:o.target_libc||detect_libc.familySync()||`unknown`,module_main:a.main,toolset:o.toolset||``,bucket:a.binary.bucket,region:a.binary.region,s3ForcePathStyle:a.binary.s3ForcePathStyle||!1,acl:o.acl||a.binary.acl||`public-read`},f=d.module_name.replace(`-`,`_`);return d.host=fix_slashes(eval_template(process.env[`npm_config_`+f+`_binary_host_mirror`]||a.binary.host,d)),d.module_path=eval_template(a.binary.module_path,d),o.module_root?d.module_path=path.join(o.module_root,d.module_path):d.module_path=path.resolve(d.module_path),d.module=path.join(d.module_path,d.module_name+`.node`),d.remote_path=a.binary.remote_path?drop_double_slashes(fix_slashes(eval_template(a.binary.remote_path,d))):``,d.package_name=eval_template(a.binary.package_name?a.binary.package_name:`{module_name}-v{version}-{node_abi}-{platform}-{arch}.tar.gz`,d),d.staged_tarball=path.join(`build/stage`,d.remote_path,d.package_name),d.s3ForcePathStyle?d.hosted_path=url.resolve(d.host,drop_double_slashes(`${d.bucket}/${d.remote_path}`)):d.hosted_path=url.resolve(d.host,d.remote_path),d.hosted_tarball=url.resolve(d.hosted_path,d.package_name),d};