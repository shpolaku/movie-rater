"use strict";module.exports=exports=publish,exports.usage=`Publishes pre-built binary (requires aws-sdk)`;const fs=require(`fs`),path=require(`path`),log=require(`./util/log.js`),versioning=require(`./util/versioning.js`),napi=require(`./util/napi.js`),s3_setup=require(`./util/s3_setup.js`),existsAsync=fs.exists||path.exists,url=require(`url`);function publish(t,o,s){let c=t.package_json,l=napi.get_napi_build_version_from_command_args(o),u=versioning.evaluate(c,t.opts,l),d=u.staged_tarball;existsAsync(d,t=>{if(!t)return s(Error(`Cannot publish because `+d+" missing: run `node-pre-gyp package` first"));log.info(`publish`,`Detecting s3 credentials`);let n=s3_setup.detect(u),r=s3_setup.get_s3(n),a=url.resolve(n.prefix,u.package_name),o={Bucket:n.bucket,Key:a};log.info(`publish`,`Authenticating with s3`),log.info(`publish`,n),log.info(`publish`,`Checking for existing binary at `+u.hosted_path),r.headObject(o,(t,i)=>{if(i&&log.info(`publish`,JSON.stringify(i)),t&&t.code===`NotFound`){log.info(`publish`,`Preparing to put object`);let t={ACL:u.acl,Body:fs.createReadStream(d),Key:a,Bucket:n.bucket};log.info(`publish`,`Putting object with ACL:`,t.ACL),log.info(`publish`,`Bucket:`,t.Bucket,`Key:`,t.Key);try{r.putObject(t,(e,t)=>(log.info(`publish`,`returned from putting object`),e?(log.info(`publish`,`s3 putObject error: "`+e+`"`),s(e)):(t&&log.info(`publish`,`s3 putObject response: "`+JSON.stringify(t)+`"`),log.info(`publish`,`successfully put object`),console.log(`[`+c.name+`] Success: published to `+u.hosted_path),s())))}catch(e){return log.info(`publish`,`s3 putObject error: "`+e+`"`),s(e)}}else if(t)return log.info(`publish`,`s3 headObject error: "`+t+`"`),s(t);else return log.error(`publish`,`Cannot publish over existing version`),log.error(`publish`,`Update the 'version' field in package.json and try again`),log.error(`publish`,`If the previous version was published in error see:`),log.error(`publish`,`	 node-pre-gyp unpublish`),s(Error(`Failed publishing to `+u.hosted_path))})})}