"use strict";const debug=require(`../internal/debug`),{MAX_LENGTH,MAX_SAFE_INTEGER}=require(`../internal/constants`),{safeRe:re,t}=require(`../internal/re`),parseOptions=require(`../internal/parse-options`),{compareIdentifiers}=require(`../internal/identifiers`);class SemVer{constructor(o,s){if(s=parseOptions(s),o instanceof SemVer){if(o.loose===!!s.loose&&o.includePrerelease===!!s.includePrerelease)return o;o=o.version}else if(typeof o!=`string`)throw TypeError(`Invalid version. Must be a string. Got type "${typeof o}".`);if(o.length>MAX_LENGTH)throw TypeError(`version is longer than ${MAX_LENGTH} characters`);debug(`SemVer`,o,s),this.options=s,this.loose=!!s.loose,this.includePrerelease=!!s.includePrerelease;let c=o.trim().match(s.loose?re[t.LOOSE]:re[t.FULL]);if(!c)throw TypeError(`Invalid Version: ${o}`);if(this.raw=o,this.major=+c[1],this.minor=+c[2],this.patch=+c[3],this.major>MAX_SAFE_INTEGER||this.major<0)throw TypeError(`Invalid major version`);if(this.minor>MAX_SAFE_INTEGER||this.minor<0)throw TypeError(`Invalid minor version`);if(this.patch>MAX_SAFE_INTEGER||this.patch<0)throw TypeError(`Invalid patch version`);c[4]?this.prerelease=c[4].split(`.`).map(e=>{if(/^[0-9]+$/.test(e)){let n=+e;if(n>=0&&n<MAX_SAFE_INTEGER)return n}return e}):this.prerelease=[],this.build=c[5]?c[5].split(`.`):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(`.`)}`),this.version}toString(){return this.version}compare(n){if(debug(`SemVer.compare`,this.version,this.options,n),!(n instanceof SemVer)){if(typeof n==`string`&&n===this.version)return 0;n=new SemVer(n,this.options)}return n.version===this.version?0:this.compareMain(n)||this.comparePre(n)}compareMain(e){return e instanceof SemVer||(e=new SemVer(e,this.options)),this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch<e.patch?-1:this.patch>e.patch?1:0}comparePre(n){if(n instanceof SemVer||(n=new SemVer(n,this.options)),this.prerelease.length&&!n.prerelease.length)return-1;if(!this.prerelease.length&&n.prerelease.length)return 1;if(!this.prerelease.length&&!n.prerelease.length)return 0;let r=0;do{let i=this.prerelease[r],a=n.prerelease[r];if(debug(`prerelease compare`,r,i,a),i===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(i===void 0)return-1;if(i===a)continue;return compareIdentifiers(i,a)}while(++r)}compareBuild(n){n instanceof SemVer||(n=new SemVer(n,this.options));let r=0;do{let i=this.build[r],a=n.build[r];if(debug(`build compare`,r,i,a),i===void 0&&a===void 0)return 0;if(a===void 0)return 1;if(i===void 0)return-1;if(i===a)continue;return compareIdentifiers(i,a)}while(++r)}inc(e,n,r){if(e.startsWith(`pre`)){if(!n&&r===!1)throw Error(`invalid increment argument: identifier is empty`);if(n){let e=`-${n}`.match(this.options.loose?re[t.PRERELEASELOOSE]:re[t.PRERELEASE]);if(!e||e[1]!==n)throw Error(`invalid identifier: ${n}`)}}switch(e){case`premajor`:this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc(`pre`,n,r);break;case`preminor`:this.prerelease.length=0,this.patch=0,this.minor++,this.inc(`pre`,n,r);break;case`prepatch`:this.prerelease.length=0,this.inc(`patch`,n,r),this.inc(`pre`,n,r);break;case`prerelease`:this.prerelease.length===0&&this.inc(`patch`,n,r),this.inc(`pre`,n,r);break;case`release`:if(this.prerelease.length===0)throw Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case`major`:(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case`minor`:(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case`patch`:this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case`pre`:{let e=Number(r)?1:0;if(this.prerelease.length===0)this.prerelease=[e];else{let i=this.prerelease.length;for(;--i>=0;)typeof this.prerelease[i]==`number`&&(this.prerelease[i]++,i=-2);if(i===-1){if(n===this.prerelease.join(`.`)&&r===!1)throw Error(`invalid increment argument: identifier already exists`);this.prerelease.push(e)}}if(n){let i=[n,e];r===!1&&(i=[n]),compareIdentifiers(this.prerelease[0],n)===0?isNaN(this.prerelease[1])&&(this.prerelease=i):this.prerelease=i}break}default:throw Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(`.`)}`),this}}module.exports=SemVer;