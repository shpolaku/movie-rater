"use strict";const SPACE_CHARACTERS=/\s+/g;class Range{constructor(r,i){if(i=parseOptions(i),r instanceof Range)return r.loose===!!i.loose&&r.includePrerelease===!!i.includePrerelease?r:new Range(r.raw,i);if(r instanceof Comparator)return this.raw=r.value,this.set=[[r]],this.formatted=void 0,this;if(this.options=i,this.loose=!!i.loose,this.includePrerelease=!!i.includePrerelease,this.raw=r.trim().replace(SPACE_CHARACTERS,` `),this.set=this.raw.split(`||`).map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let e=this.set[0];if(this.set=this.set.filter(e=>!isNullSet(e[0])),this.set.length===0)this.set=[e];else if(this.set.length>1){for(let e of this.set)if(e.length===1&&isAny(e[0])){this.set=[e];break}}}this.formatted=void 0}get range(){if(this.formatted===void 0){this.formatted=``;for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+=`||`);let n=this.set[e];for(let e=0;e<n.length;e++)e>0&&(this.formatted+=` `),this.formatted+=n[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){let n=((this.options.includePrerelease&&FLAG_INCLUDE_PRERELEASE)|(this.options.loose&&FLAG_LOOSE))+`:`+e,r=cache.get(n);if(r)return r;let a=this.options.loose,c=a?re[t.HYPHENRANGELOOSE]:re[t.HYPHENRANGE];e=e.replace(c,hyphenReplace(this.options.includePrerelease)),debug(`hyphen replace`,e),e=e.replace(re[t.COMPARATORTRIM],comparatorTrimReplace),debug(`comparator trim`,e),e=e.replace(re[t.TILDETRIM],tildeTrimReplace),debug(`tilde trim`,e),e=e.replace(re[t.CARETTRIM],caretTrimReplace),debug(`caret trim`,e);let m=e.split(` `).map(e=>parseComparator(e,this.options)).join(` `).split(/\s+/).map(e=>replaceGTE0(e,this.options));a&&(m=m.filter(e=>(debug(`loose invalid filter`,e,this.options),!!e.match(re[t.COMPARATORLOOSE])))),debug(`range list`,m);let h=new Map,g=m.map(e=>new Comparator(e,this.options));for(let e of g){if(isNullSet(e))return[e];h.set(e.value,e)}h.size>1&&h.has(``)&&h.delete(``);let _=[...h.values()];return cache.set(n,_),_}intersects(e,r){if(!(e instanceof Range))throw TypeError(`a Range is required`);return this.set.some(n=>isSatisfiable(n,r)&&e.set.some(e=>isSatisfiable(e,r)&&n.every(n=>e.every(e=>n.intersects(e,r)))))}test(e){if(!e)return!1;if(typeof e==`string`)try{e=new SemVer(e,this.options)}catch{return!1}for(let n=0;n<this.set.length;n++)if(testSet(this.set[n],e,this.options))return!0;return!1}}module.exports=Range;const LRU=require(`../internal/lrucache`),cache=new LRU,parseOptions=require(`../internal/parse-options`),Comparator=require(`./comparator`),debug=require(`../internal/debug`),SemVer=require(`./semver`),{safeRe:re,t,comparatorTrimReplace,tildeTrimReplace,caretTrimReplace}=require(`../internal/re`),{FLAG_INCLUDE_PRERELEASE,FLAG_LOOSE}=require(`../internal/constants`),isNullSet=e=>e.value===`<0.0.0-0`,isAny=e=>e.value===``,isSatisfiable=(e,n)=>{let r=!0,i=e.slice(),a=i.pop();for(;r&&i.length;)r=i.every(e=>a.intersects(e,n)),a=i.pop();return r},parseComparator=(e,n)=>(e=e.replace(re[t.BUILD],``),debug(`comp`,e,n),e=replaceCarets(e,n),debug(`caret`,e),e=replaceTildes(e,n),debug(`tildes`,e),e=replaceXRanges(e,n),debug(`xrange`,e),e=replaceStars(e,n),debug(`stars`,e),e),isX=e=>!e||e.toLowerCase()===`x`||e===`*`,replaceTildes=(e,n)=>e.trim().split(/\s+/).map(e=>replaceTilde(e,n)).join(` `),replaceTilde=(e,n)=>{let r=n.loose?re[t.TILDELOOSE]:re[t.TILDE];return e.replace(r,(n,r,i,a,o)=>{debug(`tilde`,e,n,r,i,a,o);let c;return isX(r)?c=``:isX(i)?c=`>=${r}.0.0 <${+r+1}.0.0-0`:isX(a)?c=`>=${r}.${i}.0 <${r}.${+i+1}.0-0`:o?(debug(`replaceTilde pr`,o),c=`>=${r}.${i}.${a}-${o} <${r}.${+i+1}.0-0`):c=`>=${r}.${i}.${a} <${r}.${+i+1}.0-0`,debug(`tilde return`,c),c})},replaceCarets=(e,n)=>e.trim().split(/\s+/).map(e=>replaceCaret(e,n)).join(` `),replaceCaret=(e,n)=>{debug(`caret`,e,n);let r=n.loose?re[t.CARETLOOSE]:re[t.CARET],i=n.includePrerelease?`-0`:``;return e.replace(r,(n,r,a,o,c)=>{debug(`caret`,e,n,r,a,o,c);let l;return isX(r)?l=``:isX(a)?l=`>=${r}.0.0${i} <${+r+1}.0.0-0`:isX(o)?l=r===`0`?`>=${r}.${a}.0${i} <${r}.${+a+1}.0-0`:`>=${r}.${a}.0${i} <${+r+1}.0.0-0`:c?(debug(`replaceCaret pr`,c),l=r===`0`?a===`0`?`>=${r}.${a}.${o}-${c} <${r}.${a}.${+o+1}-0`:`>=${r}.${a}.${o}-${c} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${o}-${c} <${+r+1}.0.0-0`):(debug(`no pr`),l=r===`0`?a===`0`?`>=${r}.${a}.${o}${i} <${r}.${a}.${+o+1}-0`:`>=${r}.${a}.${o}${i} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${o} <${+r+1}.0.0-0`),debug(`caret return`,l),l})},replaceXRanges=(e,n)=>(debug(`replaceXRanges`,e,n),e.split(/\s+/).map(e=>replaceXRange(e,n)).join(` `)),replaceXRange=(e,n)=>{e=e.trim();let r=n.loose?re[t.XRANGELOOSE]:re[t.XRANGE];return e.replace(r,(r,i,a,o,c,l)=>{debug(`xRange`,e,r,i,a,o,c,l);let u=isX(a),d=u||isX(o),f=d||isX(c),p=f;return i===`=`&&p&&(i=``),l=n.includePrerelease?`-0`:``,u?r=i===`>`||i===`<`?`<0.0.0-0`:`*`:i&&p?(d&&(o=0),c=0,i===`>`?(i=`>=`,d?(a=+a+1,o=0,c=0):(o=+o+1,c=0)):i===`<=`&&(i=`<`,d?a=+a+1:o=+o+1),i===`<`&&(l=`-0`),r=`${i+a}.${o}.${c}${l}`):d?r=`>=${a}.0.0${l} <${+a+1}.0.0-0`:f&&(r=`>=${a}.${o}.0${l} <${a}.${+o+1}.0-0`),debug(`xRange return`,r),r})},replaceStars=(e,n)=>(debug(`replaceStars`,e,n),e.trim().replace(re[t.STAR],``)),replaceGTE0=(e,n)=>(debug(`replaceGTE0`,e,n),e.trim().replace(re[n.includePrerelease?t.GTE0PRE:t.GTE0],``)),hyphenReplace=e=>(n,r,i,a,o,s,c,l,u,d,f,p)=>(r=isX(i)?``:isX(a)?`>=${i}.0.0${e?`-0`:``}`:isX(o)?`>=${i}.${a}.0${e?`-0`:``}`:s?`>=${r}`:`>=${r}${e?`-0`:``}`,l=isX(u)?``:isX(d)?`<${+u+1}.0.0-0`:isX(f)?`<${u}.${+d+1}.0-0`:p?`<=${u}.${d}.${f}-${p}`:e?`<${u}.${d}.${+f+1}-0`:`<=${l}`,`${r} ${l}`.trim()),testSet=(e,n,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(n))return!1;if(n.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(debug(e[r].semver),e[r].semver!==Comparator.ANY&&e[r].semver.prerelease.length>0){let i=e[r].semver;if(i.major===n.major&&i.minor===n.minor&&i.patch===n.patch)return!0}return!1}return!0};